<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form 1065 Partnership Income Calculator - MSFG Home Loans</title>
    <link rel="stylesheet" href="/css/main.css" />
    <style>
      /* Income Calculator Specific Styles */
      .income-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
        background: var(--light);
        border-radius: 8px;
        overflow: hidden;
      }
      
      .income-table th {
        background: var(--primary);
        color: var(--light);
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
      }
      
      .income-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }
      
      .income-table tr:last-child td {
        border-bottom: none;
      }
      
      .income-table tr:hover td {
        background: var(--light-gray);
      }
      
      .income-table input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 0.9rem;
        background: var(--light-gray);
      }
      
      .income-table input[type="number"]:focus {
        outline: none;
        border-color: var(--accent);
        background: var(--light);
      }
      
      .line-number {
        font-weight: 600;
        color: var(--primary);
        white-space: nowrap;
        font-size: 0.85rem;
      }
      
      .sign-col {
        text-align: center;
        font-weight: 700;
        width: 50px;
      }
      
      .sign-col.add { color: var(--success); }
      .sign-col.subtract { color: var(--danger); }
      
      .section-result {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
        border-radius: 8px;
        margin-top: 0.5rem;
      }
      
      .section-result .label {
        font-weight: 600;
        color: var(--primary);
      }
      
      .section-result .value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary);
      }
      
      .ownership-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
        padding: 1rem;
        background: var(--light-gray);
        border-radius: 8px;
      }
      
      .ownership-row label {
        font-weight: 600;
        color: var(--primary);
      }
      
      .ownership-row input {
        width: 100px;
        padding: 0.5rem;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 1rem;
        text-align: center;
      }
      
      .partnership-results {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
      }
      
      .partnership-result-item {
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
      }
      
      .partnership-result-item .label {
        font-size: 0.85rem;
        color: var(--gray);
        margin-bottom: 0.5rem;
      }
      
      .partnership-result-item .value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary);
      }
      
      /* Math Steps */
      .math-steps { display: flex; flex-direction: column; gap: 1rem; }
      .math-step { background: var(--light-gray); border-radius: 8px; padding: 1.25rem; border-left: 4px solid var(--accent); }
      .math-step.highlight { background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%); border-left-color: var(--primary); }
      .math-step h4 { color: var(--primary); margin: 0 0 0.75rem 0; font-size: 1rem; }
      .math-formula { font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--dark); line-height: 1.8; }
      .math-note { color: var(--gray); font-style: italic; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
      .math-values { display: block; margin-top: 0.5rem; padding: 0.75rem; background: var(--light); border-radius: 4px; color: var(--primary); font-weight: 600; }
      
      .policy-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .policy-box h5 { color: #856404; margin-bottom: 0.5rem; }
      .policy-box p { color: #856404; font-size: 0.9rem; margin: 0; }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="header">
        <img src="https://msfg-media.s3.us-west-2.amazonaws.com/Assets/LOGOS/Compass/Compass+Home+Loan+-+Color+Transparent+Background.png" 
             alt="Compass Home Loan" 
             class="header-logo" />
        <h1>Form 1065 Partnership Income Calculator</h1>
        <p>
          Calculate qualifying income from partnership returns (Form 1065) with adjustments for 
          depreciation, depletion, amortization, and non-recurring items.
        </p>
      </div>
      
      <div class="content">
        
        <!-- Policy Explanation -->
        <div class="policy-box">
          <h5>üìã Partnership Income Policy</h5>
          <p>
            Add back non-cash expenses (depreciation, depletion, amortization), subtract short-term debt and 
            non-deductible expenses, then apply ownership percentage. Income is averaged if declining.
          </p>
        </div>

        <!-- Partnership 1 -->
        <div class="section">
          <h2>Partnership 1</h2>
          
          <table class="income-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Line #</th>
                <th>Sign</th>
                <th>Year 1 (Most Recent)</th>
                <th>Year 2 (Prior)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Ordinary Income/Loss from Other Partnerships</td>
                <td class="line-number">4</td>
                <td class="sign-col add">+/‚àí</td>
                <td><input type="number" id="p1_ord1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_ord2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Net Farm Profit/Loss (non-recurring)</td>
                <td class="line-number">5</td>
                <td class="sign-col add">+/‚àí</td>
                <td><input type="number" id="p1_farm1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_farm2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Net Gain/Loss (non-recurring)</td>
                <td class="line-number">6</td>
                <td class="sign-col add">+/‚àí</td>
                <td><input type="number" id="p1_gain1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_gain2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Other Income/Loss (non-recurring)</td>
                <td class="line-number">7</td>
                <td class="sign-col add">+/‚àí</td>
                <td><input type="number" id="p1_oth1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_oth2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Depreciation</td>
                <td class="line-number">16a</td>
                <td class="sign-col add">+</td>
                <td><input type="number" id="p1_dep1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_dep2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Depletion</td>
                <td class="line-number">17</td>
                <td class="sign-col add">+</td>
                <td><input type="number" id="p1_depl1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_depl2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Amortization/Casualty Loss</td>
                <td class="line-number">20</td>
                <td class="sign-col add">+</td>
                <td><input type="number" id="p1_amort1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_amort2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Mortgages/Notes Payable &lt; 1 Year</td>
                <td class="line-number">Sch L ln 16</td>
                <td class="sign-col subtract">‚àí</td>
                <td><input type="number" id="p1_mort1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_mort2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Meals & Entertainment Exclusion</td>
                <td class="line-number">Sch M-1 4b</td>
                <td class="sign-col subtract">‚àí</td>
                <td><input type="number" id="p1_meals1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p1_meals2" value="0" oninput="calculate()" /></td>
              </tr>
            </tbody>
          </table>
          
          <div class="ownership-row">
            <label for="p1_owner">Ownership Percentage:</label>
            <input type="number" id="p1_owner" value="100" min="0" max="100" step="0.01" oninput="calculate()" />
            <span>%</span>
          </div>
          
          <div class="partnership-results">
            <div class="partnership-result-item">
              <div class="label">Year 1 Income</div>
              <div class="value" id="p1_year1">$0.00</div>
            </div>
            <div class="partnership-result-item">
              <div class="label">Year 2 Income</div>
              <div class="value" id="p1_year2">$0.00</div>
            </div>
            <div class="partnership-result-item">
              <div class="label">Monthly Income</div>
              <div class="value" id="p1_month">$0.00</div>
            </div>
          </div>
        </div>

        <!-- Partnership 2 -->
        <div class="section">
          <h2>Partnership 2 (Optional)</h2>
          
          <table class="income-table">
            <thead>
              <tr>
                <th>Description</th>
                <th>Line #</th>
                <th>Sign</th>
                <th>Year 1 (Most Recent)</th>
                <th>Year 2 (Prior)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Ordinary Income/Loss from Other Partnerships</td>
                <td class="line-number">4</td>
                <td class="sign-col add">+/‚àí</td>
                <td><input type="number" id="p2_ord1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_ord2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Net Farm Profit/Loss (non-recurring)</td>
                <td class="line-number">5</td>
                <td class="sign-col add">+/‚àí</td>
                <td><input type="number" id="p2_farm1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_farm2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Net Gain/Loss (non-recurring)</td>
                <td class="line-number">6</td>
                <td class="sign-col add">+/‚àí</td>
                <td><input type="number" id="p2_gain1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_gain2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Other Income/Loss (non-recurring)</td>
                <td class="line-number">7</td>
                <td class="sign-col add">+/‚àí</td>
                <td><input type="number" id="p2_oth1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_oth2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Depreciation</td>
                <td class="line-number">16a</td>
                <td class="sign-col add">+</td>
                <td><input type="number" id="p2_dep1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_dep2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Depletion</td>
                <td class="line-number">17</td>
                <td class="sign-col add">+</td>
                <td><input type="number" id="p2_depl1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_depl2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Amortization/Casualty Loss</td>
                <td class="line-number">20</td>
                <td class="sign-col add">+</td>
                <td><input type="number" id="p2_amort1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_amort2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Mortgages/Notes Payable &lt; 1 Year</td>
                <td class="line-number">Sch L ln 16</td>
                <td class="sign-col subtract">‚àí</td>
                <td><input type="number" id="p2_mort1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_mort2" value="0" oninput="calculate()" /></td>
              </tr>
              <tr>
                <td>Meals & Entertainment Exclusion</td>
                <td class="line-number">Sch M-1 4b</td>
                <td class="sign-col subtract">‚àí</td>
                <td><input type="number" id="p2_meals1" value="0" oninput="calculate()" /></td>
                <td><input type="number" id="p2_meals2" value="0" oninput="calculate()" /></td>
              </tr>
            </tbody>
          </table>
          
          <div class="ownership-row">
            <label for="p2_owner">Ownership Percentage:</label>
            <input type="number" id="p2_owner" value="100" min="0" max="100" step="0.01" oninput="calculate()" />
            <span>%</span>
          </div>
          
          <div class="partnership-results">
            <div class="partnership-result-item">
              <div class="label">Year 1 Income</div>
              <div class="value" id="p2_year1">$0.00</div>
            </div>
            <div class="partnership-result-item">
              <div class="label">Year 2 Income</div>
              <div class="value" id="p2_year2">$0.00</div>
            </div>
            <div class="partnership-result-item">
              <div class="label">Monthly Income</div>
              <div class="value" id="p2_month">$0.00</div>
            </div>
          </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
          <h2>Combined Results</h2>
          
          <div class="results-grid">
            <div class="result-card">
              <h3>Partnership 1</h3>
              <div class="result-value" id="result_p1">$0.00</div>
            </div>
            <div class="result-card">
              <h3>Partnership 2</h3>
              <div class="result-value" id="result_p2">$0.00</div>
            </div>
            <div class="result-card highlight">
              <h3>Total Monthly Income</h3>
              <div class="result-value" id="combined1065">$0.00</div>
            </div>
          </div>

          <div class="action-buttons">
            <button type="button" class="btn btn-primary" onclick="exportCSV()">üìÑ Export CSV</button>
            <button type="button" class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
            <button type="button" class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Clear All</button>
          </div>
        </div>

        <!-- Show Calculations Section -->
        <div class="chart-section">
          <div class="chart-header" onclick="toggleMath()">
            <h2>üìê Show Calculation Steps</h2>
            <button class="chart-toggle" id="mathToggle">Show Math</button>
          </div>
          <div class="chart-content" id="mathSection">
            <div class="math-steps">
              <div class="math-step">
                <h4>Partnership Income Formula</h4>
                <div class="math-formula">
                  <span class="math-note">For each partnership:</span>
                  <div class="math-values">
                    Subtotal = Ordinary + Farm + Gain + Other + Depreciation + Depletion + Amortization<br>
                    Annual Income = (Subtotal ‚àí Mortgages ‚àí Meals) √ó Ownership %<br><br>
                    IF Year 2 provided AND Year 1 > Year 2:<br>
                    &nbsp;&nbsp;Monthly = (Year 1 + Year 2) / 24<br>
                    ELSE:<br>
                    &nbsp;&nbsp;Monthly = Year 1 / 12
                  </div>
                </div>
              </div>
              
              <div class="math-step">
                <h4>Partnership 1 Calculation</h4>
                <div class="math-formula" id="mathP1">
                  <!-- Populated by JS -->
                </div>
              </div>
              
              <div class="math-step">
                <h4>Partnership 2 Calculation</h4>
                <div class="math-formula" id="mathP2">
                  <!-- Populated by JS -->
                </div>
              </div>

              <div class="math-step highlight">
                <h4>Total Monthly Income</h4>
                <div class="math-formula" id="mathTotal">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="footer">
          <div class="footer-title">Form 1065 Guidelines</div>
          <p>
            Partnership income requires analysis of the business tax return plus K-1 distributions. 
            Non-cash expenses (depreciation, depletion, amortization) are added back. Short-term debt 
            obligations and non-deductible expenses are subtracted. The borrower's share is determined 
            by their ownership percentage.
          </p>
        </div>

      </div>
    </div>

    <script>
      function parseNum(id) {
        const val = parseFloat(document.getElementById(id).value);
        return isNaN(val) ? 0 : val;
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);
      }

      function computePartnership(prefix) {
        const ord1 = parseNum(prefix + '_ord1');
        const ord2 = parseNum(prefix + '_ord2');
        const farm1 = parseNum(prefix + '_farm1');
        const farm2 = parseNum(prefix + '_farm2');
        const gain1 = parseNum(prefix + '_gain1');
        const gain2 = parseNum(prefix + '_gain2');
        const oth1 = parseNum(prefix + '_oth1');
        const oth2 = parseNum(prefix + '_oth2');
        const dep1 = parseNum(prefix + '_dep1');
        const dep2 = parseNum(prefix + '_dep2');
        const depl1 = parseNum(prefix + '_depl1');
        const depl2 = parseNum(prefix + '_depl2');
        const amort1 = parseNum(prefix + '_amort1');
        const amort2 = parseNum(prefix + '_amort2');
        const mort1 = parseNum(prefix + '_mort1');
        const mort2 = parseNum(prefix + '_mort2');
        const meals1 = parseNum(prefix + '_meals1');
        const meals2 = parseNum(prefix + '_meals2');
        const own = parseNum(prefix + '_owner') / 100;

        const sum1 = ord1 + farm1 + gain1 + oth1 + dep1 + depl1 + amort1;
        const sum2 = ord2 + farm2 + gain2 + oth2 + dep2 + depl2 + amort2;

        const total1 = (sum1 - mort1 - meals1) * own;
        const total2 = (sum2 - mort2 - meals2) * own;

        const year2Vals = [ord2, farm2, gain2, oth2, dep2, depl2, amort2, mort2, meals2];
        const hasYr2 = year2Vals.some(v => v !== 0);

        let monthly, method;
        if (hasYr2 && total1 > total2) {
          monthly = (total1 + total2) / 24;
          method = 'average';
        } else {
          monthly = total1 / 12;
          method = 'recent';
        }

        return { 
          sum1, sum2, total1, total2, monthly, method,
          mort1, mort2, meals1, meals2, own: own * 100
        };
      }

      function calculate() {
        const p1 = computePartnership('p1');
        document.getElementById('p1_year1').textContent = formatCurrency(p1.total1);
        document.getElementById('p1_year2').textContent = formatCurrency(p1.total2);
        document.getElementById('p1_month').textContent = formatCurrency(p1.monthly);
        document.getElementById('result_p1').textContent = formatCurrency(p1.monthly);

        const p2 = computePartnership('p2');
        document.getElementById('p2_year1').textContent = formatCurrency(p2.total1);
        document.getElementById('p2_year2').textContent = formatCurrency(p2.total2);
        document.getElementById('p2_month').textContent = formatCurrency(p2.monthly);
        document.getElementById('result_p2').textContent = formatCurrency(p2.monthly);

        const combined = p1.monthly + p2.monthly;
        document.getElementById('combined1065').textContent = formatCurrency(combined);

        updateMathSteps(p1, p2, combined);
      }

      function updateMathSteps(p1, p2, combined) {
        const p1Method = p1.method === 'average' ? '24-month average (Year 1 > Year 2)' : 'Year 1 / 12';
        document.getElementById('mathP1').innerHTML = `
          Subtotal Year 1: ${formatCurrency(p1.sum1)}<br>
          Subtotal Year 2: ${formatCurrency(p1.sum2)}<br>
          Less Mortgages: ${formatCurrency(p1.mort1)} / ${formatCurrency(p1.mort2)}<br>
          Less Meals: ${formatCurrency(p1.meals1)} / ${formatCurrency(p1.meals2)}<br>
          Ownership: ${p1.own}%<br>
          <div class="math-values">
            Year 1 = (${formatCurrency(p1.sum1)} - ${formatCurrency(p1.mort1)} - ${formatCurrency(p1.meals1)}) √ó ${p1.own}% = ${formatCurrency(p1.total1)}<br>
            Year 2 = ${formatCurrency(p1.total2)}<br>
            Method: ${p1Method}<br>
            <strong>Monthly: ${formatCurrency(p1.monthly)}</strong>
          </div>
        `;

        const p2Method = p2.method === 'average' ? '24-month average (Year 1 > Year 2)' : 'Year 1 / 12';
        document.getElementById('mathP2').innerHTML = `
          Subtotal Year 1: ${formatCurrency(p2.sum1)}<br>
          Subtotal Year 2: ${formatCurrency(p2.sum2)}<br>
          Ownership: ${p2.own}%<br>
          <div class="math-values">
            Year 1 = ${formatCurrency(p2.total1)}<br>
            Year 2 = ${formatCurrency(p2.total2)}<br>
            Method: ${p2Method}<br>
            <strong>Monthly: ${formatCurrency(p2.monthly)}</strong>
          </div>
        `;

        document.getElementById('mathTotal').innerHTML = `
          Partnership 1: ${formatCurrency(p1.monthly)}<br>
          + Partnership 2: ${formatCurrency(p2.monthly)}<br>
          <div class="math-values"><strong>Total Monthly: ${formatCurrency(combined)}</strong></div>
        `;
      }

      function toggleMath() {
        const section = document.getElementById('mathSection');
        const toggle = document.getElementById('mathToggle');
        section.classList.toggle('open');
        toggle.textContent = section.classList.contains('open') ? 'Hide Math' : 'Show Math';
      }

      function exportCSV() {
        const p1 = computePartnership('p1');
        const p2 = computePartnership('p2');
        const combined = p1.monthly + p2.monthly;

        const data = [
          ['Form 1065 Partnership Income Calculator'],
          [''],
          ['Partnership', 'Year 1 Income', 'Year 2 Income', 'Monthly Income'],
          ['Partnership 1', p1.total1, p1.total2, p1.monthly],
          ['Partnership 2', p2.total1, p2.total2, p2.monthly],
          [''],
          ['Total Monthly Income', '', '', combined],
          [''],
          ['Generated', new Date().toLocaleString()]
        ];

        const csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `form1065-income-${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function clearAll() {
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
          input.value = input.id.includes('owner') ? '100' : '0';
        });
        calculate();
      }

      document.addEventListener('DOMContentLoaded', calculate);
    </script>
  </body>
</html>
