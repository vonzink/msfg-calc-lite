<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>APR Calculator - MSFG Home Loans</title>
    <link rel="stylesheet" href="/css/main.css" />
    <style>
      /* APR Calculator Specific Styles */
      .apr-warning {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        color: #856404;
        font-size: 0.95rem;
      }
      
      .comparison-section {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: var(--light-gray);
        border-radius: 8px;
      }
      
      .comparison-section h3 {
        color: var(--primary);
        margin: 0 0 1rem 0;
        font-size: 1.1rem;
        text-align: center;
      }
      
      .cost-of-fees {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--light);
        border-radius: 6px;
        border: 1px solid var(--border);
      }
      
      .cost-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
      }
      
      .cost-row:last-child {
        border-bottom: none;
      }
      
      .cost-label {
        color: var(--gray);
        font-weight: 500;
      }
      
      .cost-value {
        font-weight: 700;
        color: var(--primary);
      }
      
      .cost-value.negative {
        color: var(--danger);
      }
      
      /* Math Steps Styles */
      .math-steps {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .math-step {
        background: var(--light-gray);
        border-radius: 8px;
        padding: 1.25rem;
        border-left: 4px solid var(--accent);
      }
      
      .math-step.highlight {
        background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
        border-left-color: var(--primary);
      }
      
      .math-step h4 {
        color: var(--primary);
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
      }
      
      .math-formula {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: var(--dark);
        line-height: 1.8;
      }
      
      .math-note {
        color: var(--gray);
        font-style: italic;
        font-family: 'Segoe UI', sans-serif;
        font-size: 0.85rem;
      }
      
      .math-values {
        display: block;
        margin-top: 0.5rem;
        padding: 0.75rem;
        background: var(--light);
        border-radius: 4px;
        color: var(--primary);
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="header">
        <img src="https://msfg-media.s3.us-west-2.amazonaws.com/Assets/LOGOS/Compass/Compass+Home+Loan+-+Color+Transparent+Background.png" 
             alt="Compass Home Loan" 
             class="header-logo" />
        <h1>APR Calculator</h1>
        <p>
          Calculate the Annual Percentage Rate (APR) for a mortgage loan. The APR represents 
          the true cost of borrowing including interest rate, discount points, and fees.
        </p>
      </div>
      
      <div class="content">

        <!-- Loan Information -->
        <div class="section">
          <h2>Loan Information</h2>
          <div class="input-grid">
            <div class="input-group">
              <label for="loanAmount">Loan Amount ($)</label>
              <input type="number" id="loanAmount" value="300000" min="0" step="1000" class="input-highlight" />
            </div>
            <div class="input-group">
              <label for="interestRate">Interest Rate (%)</label>
              <input type="number" id="interestRate" value="6.500" min="0" max="20" step="0.125" class="input-highlight" />
            </div>
            <div class="input-group">
              <label for="loanTerm">Loan Term (Years)</label>
              <select id="loanTerm" class="input-highlight">
                <option value="10">10 Years</option>
                <option value="15">15 Years</option>
                <option value="20">20 Years</option>
                <option value="25">25 Years</option>
                <option value="30" selected>30 Years</option>
              </select>
            </div>
            <div class="input-group">
              <label for="discountPoints">Discount Points (%)</label>
              <input type="number" id="discountPoints" value="0" min="0" max="10" step="0.125" class="input-highlight" />
            </div>
          </div>
        </div>

        <!-- Financed Fees -->
        <div class="section">
          <h2>Financed Fees</h2>
          <p class="info-text" style="margin-bottom: 1rem;">
            Fees that are rolled into the loan balance and affect the APR calculation.
          </p>
          <div class="input-row">
            <label>Total Financed Fees ($)</label>
            <input type="number" id="financedFees" value="0" min="0" step="100" class="input-highlight" />
          </div>
          <button type="button" class="btn btn-link" onclick="toggleFeeBreakdown('financed')">
            <span id="financedToggleText">‚ñº Show Fee Breakdown</span>
          </button>
          
          <div id="financedFeeBreakdown" class="fee-breakdown" style="display: none;">
            <div class="fee-section">
              <h4>APR Fees (Included in APR Calculation)</h4>
              <div class="fee-grid">
                <div class="fee-item">
                  <label for="originationFee">Origination Fee ($)</label>
                  <input type="number" id="originationFee" value="0" min="0" step="100" onchange="updateFinancedFees()" />
                </div>
                <div class="fee-item">
                  <label for="processingFee">Processing Fee ($)</label>
                  <input type="number" id="processingFee" value="0" min="0" step="100" onchange="updateFinancedFees()" />
                </div>
                <div class="fee-item">
                  <label for="underwritingFee">Underwriting Fee ($)</label>
                  <input type="number" id="underwritingFee" value="0" min="0" step="100" onchange="updateFinancedFees()" />
                </div>
                <div class="fee-item">
                  <label for="applicationFee">Application Fee ($)</label>
                  <input type="number" id="applicationFee" value="0" min="0" step="100" onchange="updateFinancedFees()" />
                </div>
                <div class="fee-item">
                  <label for="otherFinancedFees">Other APR Fees ($)</label>
                  <input type="number" id="otherFinancedFees" value="0" min="0" step="100" onchange="updateFinancedFees()" />
                </div>
              </div>
            </div>
            <div class="fee-section">
              <h4>Non-APR Fees (Not Included in APR Calculation)</h4>
              <div class="fee-grid">
                <div class="fee-item">
                  <label for="creditReportFee">Credit Report ($)</label>
                  <input type="number" id="creditReportFee" value="0" min="0" step="10" />
                </div>
                <div class="fee-item">
                  <label for="floodCertFee">Flood Certificate ($)</label>
                  <input type="number" id="floodCertFee" value="0" min="0" step="10" />
                </div>
                <div class="fee-item">
                  <label for="taxServiceFee">Tax Service ($)</label>
                  <input type="number" id="taxServiceFee" value="0" min="0" step="10" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Prepaid Fees -->
        <div class="section">
          <h2>Prepaid Fees</h2>
          <p class="info-text" style="margin-bottom: 1rem;">
            Fees paid at closing that affect the APR. Note: Monthly MI (if required) must be included in APR calculation.
          </p>
          <div class="input-row">
            <label>Total Prepaid Fees ($)</label>
            <input type="number" id="prepaidFees" value="0" min="0" step="100" class="input-highlight" />
          </div>
          <button type="button" class="btn btn-link" onclick="toggleFeeBreakdown('prepaid')">
            <span id="prepaidToggleText">‚ñº Show Fee Breakdown</span>
          </button>
          
          <div id="prepaidFeeBreakdown" class="fee-breakdown" style="display: none;">
            <div class="fee-section">
              <h4>APR Fees (Included in APR Calculation)</h4>
              <div class="fee-grid">
                <div class="fee-item">
                  <label for="prepaidInterest">Prepaid Interest ($)</label>
                  <input type="number" id="prepaidInterest" value="0" min="0" step="100" onchange="updatePrepaidFees()" />
                </div>
                <div class="fee-item">
                  <label for="mortgageInsurance">Mortgage Insurance ($)</label>
                  <input type="number" id="mortgageInsurance" value="0" min="0" step="100" onchange="updatePrepaidFees()" />
                </div>
                <div class="fee-item">
                  <label for="monthlyMI">Monthly MI (if required) ($)</label>
                  <input type="number" id="monthlyMI" value="0" min="0" step="10" onchange="updatePrepaidFees()" />
                </div>
                <div class="fee-item">
                  <label for="otherPrepaidFees">Other APR Prepaid ($)</label>
                  <input type="number" id="otherPrepaidFees" value="0" min="0" step="100" onchange="updatePrepaidFees()" />
                </div>
              </div>
            </div>
            <div class="fee-section">
              <h4>Non-APR Fees (Not Included in APR Calculation)</h4>
              <div class="fee-grid">
                <div class="fee-item">
                  <label for="escrowReserves">Escrow Reserves ($)</label>
                  <input type="number" id="escrowReserves" value="0" min="0" step="100" />
                </div>
                <div class="fee-item">
                  <label for="titleInsurance">Title Insurance ($)</label>
                  <input type="number" id="titleInsurance" value="0" min="0" step="100" />
                </div>
                <div class="fee-item">
                  <label for="recordingFees">Recording Fees ($)</label>
                  <input type="number" id="recordingFees" value="0" min="0" step="50" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Section -->
        <div class="results-section">
          <h2>APR Calculation Results</h2>
          
          <div class="results-grid">
            <div class="result-card">
              <h3>Monthly Payment (P&I)</h3>
              <div class="result-value" id="monthlyPayment">$0.00</div>
            </div>
            <div class="result-card">
              <h3>Amount Financed</h3>
              <div class="result-value" id="amountFinanced">$0.00</div>
            </div>
            <div class="result-card">
              <h3>Total Finance Charges</h3>
              <div class="result-value" id="financeCharges">$0.00</div>
            </div>
          </div>

          <!-- APR Warning (hidden by default) -->
          <div id="aprWarning" class="apr-warning" style="display: none;">
            ‚ö†Ô∏è <strong>Warning:</strong> The APR is significantly higher than the note rate. 
            This may indicate high upfront costs relative to the loan amount.
          </div>

          <div class="highlight-result">
            <h3>Annual Percentage Rate (APR)</h3>
            <div class="big-value" id="aprResult">0.000%</div>
          </div>

          <!-- APR vs Note Rate Comparison -->
          <div class="comparison-section">
            <h3>APR vs Note Rate Comparison</h3>
            <div class="comparison-grid">
              <div class="comparison-item">
                <h4>Note Rate</h4>
                <div class="value" id="noteRateDisplay" style="color: var(--primary);">0.000%</div>
                <p class="info-text">Interest rate on the loan</p>
              </div>
              <div class="comparison-item">
                <h4>APR</h4>
                <div class="value" id="aprDisplay" style="color: var(--primary);">0.000%</div>
                <p class="info-text">True cost including fees</p>
              </div>
            </div>
            <div class="cost-of-fees">
              <div class="cost-row">
                <span class="cost-label">APR Spread (Cost of Fees):</span>
                <span class="cost-value" id="aprSpread">+0.000%</span>
              </div>
              <div class="cost-row">
                <span class="cost-label">Total Upfront Costs:</span>
                <span class="cost-value" id="totalUpfrontCosts">$0.00</span>
              </div>
              <div class="cost-row">
                <span class="cost-label">Effective Monthly Cost of Fees:</span>
                <span class="cost-value" id="monthlyFeeCost">$0.00/mo</span>
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <button type="button" class="btn btn-primary" onclick="exportCSV()">
              üìÑ Export CSV
            </button>
            <button type="button" class="btn btn-secondary" onclick="printView()">
              üñ®Ô∏è Print
            </button>
            <button type="button" class="btn btn-secondary" onclick="shareLink()">
              üîó Share Link
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearAll()">
              üóëÔ∏è Clear All
            </button>
          </div>
        </div>

        <!-- Show Math Section (Collapsible) -->
        <div class="chart-section">
          <div class="chart-header" onclick="toggleMath()">
            <h2>üìê Show Calculation Steps</h2>
            <button class="chart-toggle" id="mathToggle">Show Math</button>
          </div>
          <div class="chart-content" id="mathSection">
            <div class="math-steps">
              <div class="math-step">
                <h4>Step 1: Calculate Principal for Payment</h4>
                <div class="math-formula" id="mathStep1">
                  Principal = Loan Amount + Financed Fees<br>
                  <span class="math-values"></span>
                </div>
              </div>
              
              <div class="math-step">
                <h4>Step 2: Calculate Monthly Payment (P&I)</h4>
                <div class="math-formula" id="mathStep2">
                  Payment = Principal √ó (r / (1 - (1 + r)<sup>-n</sup>))<br>
                  <span class="math-note">where r = monthly rate, n = number of payments</span><br>
                  <span class="math-values"></span>
                </div>
              </div>
              
              <div class="math-step">
                <h4>Step 3: Calculate Amount Financed (per Reg Z)</h4>
                <div class="math-formula" id="mathStep3">
                  Amount Financed = Loan Amount - Points - Prepaid Fees<br>
                  <span class="math-note">This is the net credit extended to the borrower</span><br>
                  <span class="math-values"></span>
                </div>
              </div>
              
              <div class="math-step">
                <h4>Step 4: Calculate Total Finance Charges</h4>
                <div class="math-formula" id="mathStep4">
                  Finance Charges = (Monthly Payment √ó # of Payments) - Amount Financed<br>
                  <span class="math-values"></span>
                </div>
              </div>
              
              <div class="math-step">
                <h4>Step 5: Solve for APR</h4>
                <div class="math-formula" id="mathStep5">
                  Find rate where: PV(all payments) = Amount Financed<br>
                  <span class="math-note">Using present value of annuity formula:</span><br>
                  Amount Financed = Payment √ó (1 - (1 + APR/12)<sup>-n</sup>) / (APR/12)<br>
                  <span class="math-values"></span>
                </div>
              </div>

              <div class="math-step highlight">
                <h4>Why APR > Note Rate</h4>
                <div class="math-formula" id="mathExplanation">
                  <span class="math-note">
                    The APR is higher than the note rate because you pay interest on the full principal 
                    (including financed fees), but you only "receive" the Amount Financed (after subtracting 
                    points and prepaid fees). This makes the effective cost of borrowing higher.
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- APR Explanation Footer -->
        <div class="footer">
          <div class="footer-title">APR Calculation Method</div>
          <p>
            The Annual Percentage Rate (APR) is calculated using an iterative bisection method to find the interest rate 
            that equates the present value of monthly payments to the amount financed. The calculation includes the loan amount, 
            nominal interest rate, discount points, financed fees, and prepaid fees. This method provides an accurate approximation 
            of the APR as defined by federal lending regulations. Actual APR may differ slightly depending on compounding 
            conventions, rounding practices, and specific lender policies.
          </p>
        </div>

      </div>
    </div>

    <script>
      // =====================================================
      // UTILITY FUNCTIONS
      // =====================================================
      
      function parseNum(val) {
        const n = parseFloat(val);
        return isNaN(n) ? 0 : n;
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);
      }

      function formatPercent(rate, decimals = 3) {
        return rate.toFixed(decimals) + '%';
      }

      // =====================================================
      // MORTGAGE CALCULATIONS
      // =====================================================
      
      // Calculate monthly payment using standard mortgage formula
      function calculateMonthlyPayment(principal, annualRate, years) {
        if (principal <= 0 || years <= 0) return 0;
        if (annualRate === 0) {
          return principal / (years * 12);
        }
        
        const monthlyRate = annualRate / 12;
        const numberOfPayments = years * 12;
        
        return (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -numberOfPayments));
      }

      // Calculate present value using closed-form annuity formula (much faster)
      function calculatePresentValue(payment, annualRate, numberOfPayments) {
        if (payment <= 0 || numberOfPayments <= 0) return 0;
        if (annualRate === 0) {
          return payment * numberOfPayments;
        }
        
        const monthlyRate = annualRate / 12;
        // PV of annuity formula: PMT √ó (1 - (1+r)^-n) / r
        return payment * (1 - Math.pow(1 + monthlyRate, -numberOfPayments)) / monthlyRate;
      }

      // Calculate APR using bisection method
      // Finds the rate where PV of all payments = Amount Financed (per Reg Z)
      function calculateAPR(monthlyPayment, amountFinanced, numberOfPayments) {
        // Edge case validation
        if (amountFinanced <= 0 || monthlyPayment <= 0 || numberOfPayments <= 0) {
          return 0;
        }
        
        // Sanity check: if total payments < amount financed, something's wrong
        const totalPayments = monthlyPayment * numberOfPayments;
        if (totalPayments < amountFinanced) {
          return 0;
        }

        let lowerRate = 0.0001;  // Start slightly above 0 to avoid division issues
        let upperRate = 1;       // 100% APR ceiling (more than enough for mortgages)
        let apr = 0;
        const tolerance = 0.00000001;  // Very tight tolerance for accuracy
        const maxIterations = 100;

        for (let i = 0; i < maxIterations; i++) {
          apr = (lowerRate + upperRate) / 2;
          const presentValue = calculatePresentValue(monthlyPayment, apr, numberOfPayments);

          if (Math.abs(presentValue - amountFinanced) < tolerance) {
            break;
          }

          // If PV > amount financed, rate is too low (less discounting)
          // If PV < amount financed, rate is too high (more discounting)
          if (presentValue > amountFinanced) {
            lowerRate = apr;
          } else {
            upperRate = apr;
          }
        }

        return apr;
      }

      // =====================================================
      // STATE MANAGEMENT
      // =====================================================
      
      function getCurrentState() {
        return {
          loanAmount: parseNum(document.getElementById('loanAmount').value),
          interestRate: parseNum(document.getElementById('interestRate').value) / 100,
          loanTerm: parseNum(document.getElementById('loanTerm').value),
          discountPoints: parseNum(document.getElementById('discountPoints').value) / 100,
          financedFees: parseNum(document.getElementById('financedFees').value),
          prepaidFees: parseNum(document.getElementById('prepaidFees').value)
        };
      }

      // =====================================================
      // MAIN CALCULATION
      // =====================================================
      
      function calculateResults() {
        const state = getCurrentState();

        // Validate inputs
        if (state.loanAmount <= 0) {
          document.getElementById('monthlyPayment').textContent = '$0.00';
          document.getElementById('amountFinanced').textContent = '$0.00';
          document.getElementById('financeCharges').textContent = '$0.00';
          document.getElementById('aprResult').textContent = '0.000%';
          document.getElementById('noteRateDisplay').textContent = '0.000%';
          document.getElementById('aprDisplay').textContent = '0.000%';
          document.getElementById('aprSpread').textContent = '+0.000%';
          document.getElementById('totalUpfrontCosts').textContent = '$0.00';
          document.getElementById('monthlyFeeCost').textContent = '$0.00/mo';
          document.getElementById('aprWarning').style.display = 'none';
          return;
        }

        // Calculate principal (loan + financed fees that are rolled into the loan)
        const principal = state.loanAmount + state.financedFees;

        // Calculate monthly payment at the note rate
        const monthlyPayment = calculateMonthlyPayment(principal, state.interestRate, state.loanTerm);

        // Calculate Amount Financed per Reg Z:
        // = Loan Amount - Prepaid Finance Charges (points + prepaid fees)
        const pointsAmount = state.loanAmount * state.discountPoints;
        const amountFinanced = state.loanAmount - pointsAmount - state.prepaidFees;

        // Calculate total payments and finance charges
        const numberOfPayments = state.loanTerm * 12;
        const totalPayments = monthlyPayment * numberOfPayments;
        const financeCharges = totalPayments - amountFinanced;

        // Calculate APR - the rate that makes PV(payments) = Amount Financed
        let apr = 0;
        if (amountFinanced > 0) {
          apr = calculateAPR(monthlyPayment, amountFinanced, numberOfPayments);
        }

        // Calculate comparison metrics
        const aprSpread = (apr - state.interestRate) * 100;  // In percentage points
        const totalUpfrontCosts = pointsAmount + state.prepaidFees + state.financedFees;
        const monthlyFeeCost = totalUpfrontCosts / numberOfPayments;

        // Update main display
        document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
        document.getElementById('amountFinanced').textContent = formatCurrency(Math.max(0, amountFinanced));
        document.getElementById('financeCharges').textContent = formatCurrency(Math.max(0, financeCharges));
        document.getElementById('aprResult').textContent = formatPercent(apr * 100);

        // Update comparison section
        document.getElementById('noteRateDisplay').textContent = formatPercent(state.interestRate * 100);
        document.getElementById('aprDisplay').textContent = formatPercent(apr * 100);
        document.getElementById('aprSpread').textContent = '+' + aprSpread.toFixed(3) + '%';
        document.getElementById('totalUpfrontCosts').textContent = formatCurrency(totalUpfrontCosts);
        document.getElementById('monthlyFeeCost').textContent = formatCurrency(monthlyFeeCost) + '/mo';

        // Show warning if APR is significantly higher than note rate (more than 0.5%)
        const warningEl = document.getElementById('aprWarning');
        if (aprSpread > 0.5) {
          warningEl.style.display = 'block';
        } else {
          warningEl.style.display = 'none';
        }

        // Update math steps
        updateMathSteps(state, principal, monthlyPayment, pointsAmount, amountFinanced, numberOfPayments, totalPayments, financeCharges, apr);

        // Update URL
        updateURL(state);
      }

      // =====================================================
      // MATH STEPS UPDATE
      // =====================================================
      
      function updateMathSteps(state, principal, monthlyPayment, pointsAmount, amountFinanced, numberOfPayments, totalPayments, financeCharges, apr) {
        // Step 1: Principal
        document.querySelector('#mathStep1 .math-values').innerHTML = 
          `Principal = ${formatCurrency(state.loanAmount)} + ${formatCurrency(state.financedFees)} = <strong>${formatCurrency(principal)}</strong>`;

        // Step 2: Monthly Payment
        const monthlyRate = state.interestRate / 12;
        document.querySelector('#mathStep2 .math-values').innerHTML = 
          `r = ${(state.interestRate * 100).toFixed(3)}% / 12 = ${(monthlyRate * 100).toFixed(5)}% monthly<br>` +
          `n = ${state.loanTerm} years √ó 12 = ${numberOfPayments} payments<br>` +
          `Payment = ${formatCurrency(principal)} √ó (${monthlyRate.toFixed(6)} / (1 - (1 + ${monthlyRate.toFixed(6)})<sup>-${numberOfPayments}</sup>))<br>` +
          `Payment = <strong>${formatCurrency(monthlyPayment)}</strong>`;

        // Step 3: Amount Financed
        document.querySelector('#mathStep3 .math-values').innerHTML = 
          `Points = ${formatCurrency(state.loanAmount)} √ó ${(state.discountPoints * 100).toFixed(3)}% = ${formatCurrency(pointsAmount)}<br>` +
          `Amount Financed = ${formatCurrency(state.loanAmount)} - ${formatCurrency(pointsAmount)} - ${formatCurrency(state.prepaidFees)}<br>` +
          `Amount Financed = <strong>${formatCurrency(amountFinanced)}</strong>`;

        // Step 4: Finance Charges
        document.querySelector('#mathStep4 .math-values').innerHTML = 
          `Total Payments = ${formatCurrency(monthlyPayment)} √ó ${numberOfPayments} = ${formatCurrency(totalPayments)}<br>` +
          `Finance Charges = ${formatCurrency(totalPayments)} - ${formatCurrency(amountFinanced)}<br>` +
          `Finance Charges = <strong>${formatCurrency(financeCharges)}</strong>`;

        // Step 5: APR
        const aprMonthlyRate = apr / 12;
        document.querySelector('#mathStep5 .math-values').innerHTML = 
          `Solving: ${formatCurrency(amountFinanced)} = ${formatCurrency(monthlyPayment)} √ó (1 - (1 + r)<sup>-${numberOfPayments}</sup>) / r<br>` +
          `APR monthly rate = ${(aprMonthlyRate * 100).toFixed(5)}%<br>` +
          `<strong>APR = ${formatPercent(apr * 100)}</strong>`;
      }

      // =====================================================
      // TOGGLE FUNCTIONS
      // =====================================================
      
      function toggleMath() {
        const mathSection = document.getElementById('mathSection');
        const toggleBtn = document.getElementById('mathToggle');
        
        if (mathSection.classList.contains('open')) {
          mathSection.classList.remove('open');
          toggleBtn.textContent = 'Show Math';
        } else {
          mathSection.classList.add('open');
          toggleBtn.textContent = 'Hide Math';
        }
      }

      // =====================================================
      // URL STATE MANAGEMENT
      // =====================================================
      
      function serializeState(state) {
        return new URLSearchParams({
          la: state.loanAmount.toString(),
          ir: (state.interestRate * 100).toString(),
          lt: state.loanTerm.toString(),
          dp: (state.discountPoints * 100).toString(),
          ff: state.financedFees.toString(),
          pf: state.prepaidFees.toString()
        }).toString();
      }

      function deserializeState(params) {
        return {
          loanAmount: parseNum(params.get('la')) || 300000,
          interestRate: (parseNum(params.get('ir')) || 6.5) / 100,
          loanTerm: parseNum(params.get('lt')) || 30,
          discountPoints: (parseNum(params.get('dp')) || 0) / 100,
          financedFees: parseNum(params.get('ff')) || 0,
          prepaidFees: parseNum(params.get('pf')) || 0
        };
      }

      function updateURL(state) {
        const url = new URL(window.location);
        url.search = serializeState(state);
        window.history.replaceState({}, '', url);
      }

      function applyState(state) {
        document.getElementById('loanAmount').value = state.loanAmount;
        document.getElementById('interestRate').value = (state.interestRate * 100).toFixed(3);
        document.getElementById('loanTerm').value = state.loanTerm;
        document.getElementById('discountPoints').value = (state.discountPoints * 100).toFixed(3);
        document.getElementById('financedFees').value = state.financedFees;
        document.getElementById('prepaidFees').value = state.prepaidFees;
      }

      // =====================================================
      // FEE BREAKDOWN TOGGLE
      // =====================================================
      
      function toggleFeeBreakdown(type) {
        const breakdown = document.getElementById(type + 'FeeBreakdown');
        const toggleText = document.getElementById(type + 'ToggleText');
        
        if (breakdown.style.display === 'none') {
          breakdown.style.display = 'block';
          toggleText.textContent = '‚ñ≤ Hide Fee Breakdown';
        } else {
          breakdown.style.display = 'none';
          toggleText.textContent = '‚ñº Show Fee Breakdown';
        }
      }

      function updateFinancedFees() {
        const aprFees = [
          'originationFee',
          'processingFee', 
          'underwritingFee',
          'applicationFee',
          'otherFinancedFees'
        ];
        
        let total = 0;
        aprFees.forEach(feeId => {
          total += parseNum(document.getElementById(feeId).value);
        });
        
        document.getElementById('financedFees').value = total;
        calculateResults();
      }

      function updatePrepaidFees() {
        const aprFees = [
          'prepaidInterest',
          'mortgageInsurance',
          'monthlyMI',
          'otherPrepaidFees'
        ];
        
        let total = 0;
        aprFees.forEach(feeId => {
          total += parseNum(document.getElementById(feeId).value);
        });
        
        document.getElementById('prepaidFees').value = total;
        calculateResults();
      }

      // =====================================================
      // EXPORT FUNCTIONS
      // =====================================================
      
      function exportCSV() {
        const state = getCurrentState();
        const principal = state.loanAmount + state.financedFees;
        const monthlyPayment = calculateMonthlyPayment(principal, state.interestRate, state.loanTerm);
        const pointsAmount = state.loanAmount * state.discountPoints;
        const amountFinanced = state.loanAmount - pointsAmount - state.prepaidFees;
        const totalPayments = monthlyPayment * state.loanTerm * 12;
        const financeCharges = totalPayments - amountFinanced;
        const numberOfPayments = state.loanTerm * 12;
        const apr = calculateAPR(monthlyPayment, amountFinanced, numberOfPayments);
        
        const csvData = [
          ['APR Calculator Results', ''],
          ['', ''],
          ['Loan Information', ''],
          ['Loan Amount', formatCurrency(state.loanAmount)],
          ['Interest Rate', formatPercent(state.interestRate * 100, 3)],
          ['Loan Term', state.loanTerm + ' years'],
          ['Discount Points', formatPercent(state.discountPoints * 100, 3)],
          ['Financed Fees', formatCurrency(state.financedFees)],
          ['Prepaid Fees', formatCurrency(state.prepaidFees)],
          ['', ''],
          ['Calculation Results', ''],
          ['Monthly Payment (P&I)', formatCurrency(monthlyPayment)],
          ['Amount Financed', formatCurrency(amountFinanced)],
          ['Total Finance Charges', formatCurrency(financeCharges)],
          ['Annual Percentage Rate (APR)', formatPercent(apr * 100, 3)],
          ['', ''],
          ['Generated on', new Date().toLocaleString()]
        ];
        
        const csvContent = csvData.map(row => row.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'apr_calculation.csv';
        link.click();
        URL.revokeObjectURL(url);
      }

      function printView() {
        window.print();
      }

      function shareLink() {
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('Link copied to clipboard!');
        }).catch(() => {
          alert('Unable to copy link. Please copy the URL manually.');
        });
      }

      function clearAll() {
        const defaultState = {
          loanAmount: 300000,
          interestRate: 0.065,
          loanTerm: 30,
          discountPoints: 0,
          financedFees: 0,
          prepaidFees: 0
        };
        applyState(defaultState);
        
        // Clear fee breakdown fields
        const feeFields = [
          'originationFee', 'processingFee', 'underwritingFee', 'applicationFee',
          'otherFinancedFees', 'creditReportFee', 'floodCertFee', 'taxServiceFee',
          'prepaidInterest', 'mortgageInsurance', 'monthlyMI', 'otherPrepaidFees',
          'escrowReserves', 'titleInsurance', 'recordingFees'
        ];
        feeFields.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = 0;
        });
        
        calculateResults();
      }

      // =====================================================
      // EVENT LISTENERS
      // =====================================================
      
      function wireEvents() {
        const inputs = ['loanAmount', 'interestRate', 'loanTerm', 'discountPoints', 'financedFees', 'prepaidFees'];
        inputs.forEach(id => {
          document.getElementById(id).addEventListener('input', calculateResults);
          document.getElementById(id).addEventListener('change', calculateResults);
        });
      }

      // =====================================================
      // INITIALIZE
      // =====================================================
      
      function initialize() {
        const urlParams = new URLSearchParams(window.location.search);
        const state = deserializeState(urlParams);
        applyState(state);
        wireEvents();
        calculateResults();
      }

      document.addEventListener('DOMContentLoaded', initialize);
    </script>
  </body>
</html>
