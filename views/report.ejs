<div class="report-page">

  <div class="report-page__header">
    <h1>
      Session Report
      <span class="report-page__header-count" id="reportCount"></span>
    </h1>
    <div class="report-page__actions" id="reportActions" style="display:none;">
      <button class="btn btn-outline" id="btnPrintReport">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Print
      </button>
      <button class="btn btn-outline" id="btnPdfReport">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Export PDF
      </button>
      <button class="btn btn-outline" id="btnClearReport" style="color: var(--color-danger, #dc3545); border-color: var(--color-danger, #dc3545);">
        Clear All
      </button>
    </div>
  </div>

  <!-- Empty state -->
  <div class="report-empty" id="reportEmpty">
    <div class="report-empty__icon">
      <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
    </div>
    <div class="report-empty__title">No items in your report yet</div>
    <p class="report-empty__text">
      Use the <strong>Add to Report</strong> button on any calculator to capture your work.
      Items will appear here for viewing, printing, or PDF export.
    </p>
  </div>

  <!-- Report items container -->
  <div class="report-items" id="reportItems"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(function() {
  'use strict';

  var itemsContainer = document.getElementById('reportItems');
  var emptyState = document.getElementById('reportEmpty');
  var actionsBar = document.getElementById('reportActions');
  var countEl = document.getElementById('reportCount');

  function formatTime(isoString) {
    var d = new Date(isoString);
    return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) +
           ' â€” ' + d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function render() {
    var items = MSFG.Report.getItems();
    itemsContainer.innerHTML = '';

    if (items.length === 0) {
      emptyState.style.display = '';
      actionsBar.style.display = 'none';
      countEl.textContent = '';
      return;
    }

    emptyState.style.display = 'none';
    actionsBar.style.display = 'flex';
    countEl.textContent = '(' + items.length + ' item' + (items.length !== 1 ? 's' : '') + ')';

    items.forEach(function(item) {
      var div = document.createElement('div');
      div.className = 'report-item';
      div.setAttribute('data-id', item.id);
      div.innerHTML =
        '<div class="report-item__header">' +
          '<div class="report-item__info">' +
            '<span class="report-item__icon">' + item.icon + '</span>' +
            '<span class="report-item__name">' + item.name + '</span>' +
            '<span class="report-item__time">' + formatTime(item.timestamp) + '</span>' +
          '</div>' +
          '<button class="report-item__remove" data-id="' + item.id + '">Remove</button>' +
        '</div>' +
        '<div class="report-item__body">' +
          '<img class="report-item__image" src="' + item.imageData + '" alt="' + item.name + ' snapshot">' +
        '</div>';
      itemsContainer.appendChild(div);
    });

    // Remove handlers
    itemsContainer.querySelectorAll('.report-item__remove').forEach(function(btn) {
      btn.addEventListener('click', function() {
        MSFG.Report.removeItem(this.getAttribute('data-id'));
        render();
      });
    });
  }

  // Print
  document.getElementById('btnPrintReport').addEventListener('click', function() {
    window.print();
  });

  // PDF export
  document.getElementById('btnPdfReport').addEventListener('click', function() {
    var items = MSFG.Report.getItems();
    if (items.length === 0) return;

    var jsPDF = window.jspdf.jsPDF;
    var pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'letter' });
    var pageW = pdf.internal.pageSize.getWidth();
    var pageH = pdf.internal.pageSize.getHeight();
    var margin = 15;
    var usableW = pageW - margin * 2;
    var yPos = margin;

    // Title
    pdf.setFontSize(18);
    pdf.setFont(undefined, 'bold');
    pdf.text('MSFG Session Report', margin, yPos + 6);
    yPos += 14;
    pdf.setFontSize(9);
    pdf.setFont(undefined, 'normal');
    pdf.setTextColor(120);
    pdf.text('Generated ' + new Date().toLocaleString(), margin, yPos);
    pdf.setTextColor(0);
    yPos += 10;

    var pending = items.length;
    var loaded = 0;

    items.forEach(function(item, idx) {
      var img = new Image();
      img.onload = function() {
        item._img = img;
        item._w = img.naturalWidth;
        item._h = img.naturalHeight;
        loaded++;
        if (loaded === pending) buildPdf();
      };
      img.onerror = function() {
        item._img = null;
        loaded++;
        if (loaded === pending) buildPdf();
      };
      img.src = item.imageData;
    });

    function buildPdf() {
      items.forEach(function(item, idx) {
        if (idx > 0) { pdf.addPage(); yPos = margin; }

        // Item header
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'bold');
        pdf.text(item.icon + '  ' + item.name, margin, yPos + 4);
        yPos += 7;
        pdf.setFontSize(8);
        pdf.setFont(undefined, 'normal');
        pdf.setTextColor(100);
        pdf.text(formatTime(item.timestamp), margin, yPos + 2);
        pdf.setTextColor(0);
        yPos += 8;

        // Image
        if (item._img) {
          var ratio = item._w / item._h;
          var imgW = usableW;
          var imgH = imgW / ratio;
          var maxH = pageH - yPos - margin;
          if (imgH > maxH) {
            imgH = maxH;
            imgW = imgH * ratio;
          }
          pdf.addImage(item._img, 'JPEG', margin, yPos, imgW, imgH);
        }
      });

      pdf.save('MSFG-Report-' + new Date().toISOString().slice(0, 10) + '.pdf');
    }
  });

  // Clear all
  document.getElementById('btnClearReport').addEventListener('click', function() {
    if (confirm('Remove all items from your report?')) {
      MSFG.Report.clear();
      render();
    }
  });

  // Initial render
  render();
})();
</script>
