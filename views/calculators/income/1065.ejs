<div class="calc-page">
  <div class="calc-page__header">
    <h1>Form 1065 Partnership Income Calculator</h1>
    <p>Calculate qualifying income from partnership returns (Form 1065) with adjustments for depreciation, depletion, amortization, and non-recurring items.</p>
  </div>

  <div class="calc-page__body">

    <!-- Upload Zone -->
    <div class="calc-section">
      <h2>Upload Form 1065</h2>
      <p class="text-muted text-sm" style="margin-bottom: var(--space-sm);">Upload IRS Form 1065 pages to auto-fill fields. Upload one per tax year (max 2). Include Schedule L and M-1 pages if available.</p>

      <div class="upload-zone" data-upload-type="income-1065">
        <div class="upload-zone__icon">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <div class="upload-zone__text">
          <strong>Upload Form 1065</strong>
          <span>Drop or click to upload a 1065 image or PDF</span>
        </div>
        <input type="file" class="upload-zone__input" accept="image/*,application/pdf" style="display: none;">
        <div class="upload-zone__status"></div>
      </div>

      <!-- JS-rendered document cards -->
      <div id="docCards"></div>
    </div>

    <!-- Policy Explanation -->
    <div class="calc-section">
      <div class="policy-box">
        <h5>Partnership Income Policy</h5>
        <p>
          Add back non-cash expenses (depreciation, depletion, amortization), subtract short-term debt and
          non-deductible expenses, then apply ownership percentage. If two years are provided and Year 1
          exceeds Year 2, income is averaged over 24 months. Otherwise, only the most recent year is used.
        </p>
      </div>
    </div>

    <!-- Partnership 1 -->
    <div class="calc-section">
      <h2>Partnership 1</h2>
      <p class="text-muted text-sm" style="margin-bottom: var(--space-sm);">Enter line items from the partnership's Form 1065. Positive values are added; negative values reduce income.</p>

      <table class="income-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Line #</th>
            <th>Sign</th>
            <th>Year 1 (Most Recent)</th>
            <th>Year 2 (Prior)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Ordinary Income/Loss</td>
            <td class="line-number">4</td>
            <td class="sign-col add">+/&minus;</td>
            <td><input type="number" id="p1_ord1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_ord2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Net Farm Profit/Loss</td>
            <td class="line-number">5</td>
            <td class="sign-col add">+/&minus;</td>
            <td><input type="number" id="p1_farm1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_farm2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Net Gain/Loss</td>
            <td class="line-number">6</td>
            <td class="sign-col add">+/&minus;</td>
            <td><input type="number" id="p1_gain1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_gain2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Other Income/Loss</td>
            <td class="line-number">7</td>
            <td class="sign-col add">+/&minus;</td>
            <td><input type="number" id="p1_oth1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_oth2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Depreciation</td>
            <td class="line-number">16a</td>
            <td class="sign-col add">+</td>
            <td><input type="number" id="p1_dep1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_dep2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Depletion</td>
            <td class="line-number">17</td>
            <td class="sign-col add">+</td>
            <td><input type="number" id="p1_depl1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_depl2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Amortization/Casualty Loss</td>
            <td class="line-number">20</td>
            <td class="sign-col add">+</td>
            <td><input type="number" id="p1_amort1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_amort2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Mortgages/Notes Payable &lt; 1 Year</td>
            <td class="line-number">Sch L ln 16</td>
            <td class="sign-col subtract">&minus;</td>
            <td><input type="number" id="p1_mort1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_mort2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Meals &amp; Entertainment Exclusion</td>
            <td class="line-number">Sch M-1 4b</td>
            <td class="sign-col subtract">&minus;</td>
            <td><input type="number" id="p1_meals1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p1_meals2" value="0" oninput="calculate()"></td>
          </tr>
        </tbody>
      </table>

      <div class="ownership-row">
        <label for="p1_owner">Ownership Percentage:</label>
        <input type="number" id="p1_owner" value="100" min="0" max="100" step="0.01" oninput="calculate()">
        <span>%</span>
      </div>

      <div class="partnership-results">
        <div class="partnership-result-item">
          <div class="label">Year 1 Income</div>
          <div class="value" id="p1_year1">$0.00</div>
        </div>
        <div class="partnership-result-item">
          <div class="label">Year 2 Income</div>
          <div class="value" id="p1_year2">$0.00</div>
        </div>
        <div class="partnership-result-item">
          <div class="label">Monthly Income</div>
          <div class="value" id="p1_month">$0.00</div>
        </div>
      </div>
    </div>

    <!-- Partnership 2 -->
    <div class="calc-section">
      <h2>Partnership 2 (Optional)</h2>
      <p class="text-muted text-sm" style="margin-bottom: var(--space-sm);">Use this section if the borrower has income from a second partnership.</p>

      <table class="income-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Line #</th>
            <th>Sign</th>
            <th>Year 1 (Most Recent)</th>
            <th>Year 2 (Prior)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Ordinary Income/Loss</td>
            <td class="line-number">4</td>
            <td class="sign-col add">+/&minus;</td>
            <td><input type="number" id="p2_ord1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_ord2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Net Farm Profit/Loss</td>
            <td class="line-number">5</td>
            <td class="sign-col add">+/&minus;</td>
            <td><input type="number" id="p2_farm1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_farm2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Net Gain/Loss</td>
            <td class="line-number">6</td>
            <td class="sign-col add">+/&minus;</td>
            <td><input type="number" id="p2_gain1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_gain2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Other Income/Loss</td>
            <td class="line-number">7</td>
            <td class="sign-col add">+/&minus;</td>
            <td><input type="number" id="p2_oth1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_oth2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Depreciation</td>
            <td class="line-number">16a</td>
            <td class="sign-col add">+</td>
            <td><input type="number" id="p2_dep1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_dep2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Depletion</td>
            <td class="line-number">17</td>
            <td class="sign-col add">+</td>
            <td><input type="number" id="p2_depl1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_depl2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Amortization/Casualty Loss</td>
            <td class="line-number">20</td>
            <td class="sign-col add">+</td>
            <td><input type="number" id="p2_amort1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_amort2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Mortgages/Notes Payable &lt; 1 Year</td>
            <td class="line-number">Sch L ln 16</td>
            <td class="sign-col subtract">&minus;</td>
            <td><input type="number" id="p2_mort1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_mort2" value="0" oninput="calculate()"></td>
          </tr>
          <tr>
            <td>Meals &amp; Entertainment Exclusion</td>
            <td class="line-number">Sch M-1 4b</td>
            <td class="sign-col subtract">&minus;</td>
            <td><input type="number" id="p2_meals1" value="0" oninput="calculate()"></td>
            <td><input type="number" id="p2_meals2" value="0" oninput="calculate()"></td>
          </tr>
        </tbody>
      </table>

      <div class="ownership-row">
        <label for="p2_owner">Ownership Percentage:</label>
        <input type="number" id="p2_owner" value="100" min="0" max="100" step="0.01" oninput="calculate()">
        <span>%</span>
      </div>

      <div class="partnership-results">
        <div class="partnership-result-item">
          <div class="label">Year 1 Income</div>
          <div class="value" id="p2_year1">$0.00</div>
        </div>
        <div class="partnership-result-item">
          <div class="label">Year 2 Income</div>
          <div class="value" id="p2_year2">$0.00</div>
        </div>
        <div class="partnership-result-item">
          <div class="label">Monthly Income</div>
          <div class="value" id="p2_month">$0.00</div>
        </div>
      </div>
    </div>

    <!-- Combined Results -->
    <div class="calc-section">
      <h2>Combined Results</h2>

      <div class="results-grid">
        <div class="result-card">
          <div class="result-card__label">Partnership 1</div>
          <div class="result-card__value" id="result_p1">$0.00</div>
        </div>
        <div class="result-card">
          <div class="result-card__label">Partnership 2</div>
          <div class="result-card__value" id="result_p2">$0.00</div>
        </div>
      </div>

      <div class="result-highlight" style="margin-top: var(--space-lg);">
        <div class="result-highlight__label">Total Monthly Income</div>
        <div class="result-highlight__value" id="combined1065">$0.00</div>
      </div>

      <div class="action-bar">
        <button type="button" class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
        <button type="button" class="btn btn-secondary" onclick="window.print()">Print</button>
        <button type="button" class="btn btn-ghost" onclick="clearAll()">Clear All</button>
      </div>
    </div>

    <%- include('../../partials/show-calculations', { calcId: 'income-1065' }) %>

  </div>

  <div class="calc-page__footer">
    <div class="calc-page__footer-title">Form 1065 Guidelines</div>
    <p>
      Partnership income requires analysis of the business tax return plus K-1 distributions.
      Non-cash expenses (depreciation, depletion, amortization) are added back. Short-term debt
      obligations and non-deductible expenses are subtracted. The borrower's share is determined
      by their ownership percentage.
    </p>
  </div>
</div>
