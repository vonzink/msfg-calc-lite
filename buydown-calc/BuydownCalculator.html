<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buydown Calculator - MSFG Home Loans</title>
    <link rel="stylesheet" href="/css/main.css" />
    <style>
      /* Buydown Calculator Specific Styles */
      .buydown-chip {
        display: inline-block;
        background: var(--light);
        border: 1px solid var(--border);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
      }
      
      .buydown-chip.highlight {
        background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
        border: 2px solid var(--success);
        color: var(--success);
        font-weight: 700;
      }
      
      .chips-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
      }
      
      .year-card {
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .year-card h4 {
        color: var(--primary);
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .year-card h4 .rate-badge {
        background: var(--accent);
        color: var(--light);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
      }
      
      .year-card.full-rate h4 .rate-badge {
        background: var(--primary);
      }
      
      .year-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
      }
      
      .year-item {
        text-align: center;
        padding: 0.5rem;
        background: var(--light-gray);
        border-radius: 6px;
      }
      
      .year-item .label {
        font-size: 0.75rem;
        color: var(--gray);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .year-item .value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark);
        margin-top: 0.25rem;
      }
      
      .savings-badge {
        color: var(--success);
        font-weight: 600;
      }
      
      /* Toggle Switches */
      .toggle-row {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.75rem;
      }
      
      .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: var(--border);
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      
      .toggle-switch.active {
        background: var(--accent);
      }
      
      .toggle-switch::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background: var(--light);
        border-radius: 50%;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .toggle-switch.active::after {
        transform: translateX(24px);
      }
      
      .toggle-label {
        font-weight: 500;
        color: var(--dark);
        cursor: pointer;
      }
      
      /* Warning Box */
      .warning-box {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        color: #856404;
        font-size: 0.95rem;
      }
      
      .warning-box.error {
        background: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }
      
      /* Math Steps */
      .math-steps {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .math-step {
        background: var(--light-gray);
        border-radius: 8px;
        padding: 1.25rem;
        border-left: 4px solid var(--accent);
      }
      
      .math-step.highlight {
        background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
        border-left-color: var(--primary);
      }
      
      .math-step h4 {
        color: var(--primary);
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
      }
      
      .math-formula {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: var(--dark);
        line-height: 1.8;
      }
      
      .math-note {
        color: var(--gray);
        font-style: italic;
        font-family: 'Segoe UI', sans-serif;
        font-size: 0.85rem;
      }
      
      .math-values {
        display: block;
        margin-top: 0.5rem;
        padding: 0.75rem;
        background: var(--light);
        border-radius: 4px;
        color: var(--primary);
        font-weight: 600;
      }
      
      .math-table {
        width: 100%;
        margin-top: 0.5rem;
        border-collapse: collapse;
      }
      
      .math-table th,
      .math-table td {
        padding: 0.5rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
        font-size: 0.85rem;
      }
      
      .math-table th {
        background: var(--light);
        font-weight: 600;
        color: var(--primary);
      }
      
      .math-table td {
        font-family: 'Courier New', monospace;
      }
      
      /* Chart Container */
      #chartContainer {
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
      }
      
      #buydownChart {
        max-width: 100%;
        height: 300px;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="header">
        <img src="https://msfg-media.s3.us-west-2.amazonaws.com/Assets/LOGOS/Compass/Compass+Home+Loan+-+Color+Transparent+Background.png" 
             alt="Compass Home Loan" 
             class="header-logo" />
        <h1>Buydown Calculator</h1>
        <p>
          Calculate the cost and payment savings of a temporary interest rate buydown. 
          See how 3-2-1, 2-1, 1-1, and 1-0 buydowns reduce your monthly payments in the early years.
        </p>
      </div>
      
      <div class="content">

        <!-- Loan Information -->
        <div class="section">
          <h2>Loan Information</h2>
          <div class="input-grid">
            <div class="input-group">
              <label for="loanAmount">Loan Amount ($)</label>
              <input type="number" id="loanAmount" value="400000" min="0" step="1000" class="input-highlight" />
            </div>
            <div class="input-group">
              <label for="noteRate">Note Rate (%)</label>
              <input type="number" id="noteRate" value="7.000" min="0" max="15" step="0.125" class="input-highlight" />
            </div>
            <div class="input-group">
              <label for="loanTerm">Loan Term (Years)</label>
              <select id="loanTerm" class="input-highlight">
                <option value="15">15 Years</option>
                <option value="20">20 Years</option>
                <option value="30" selected>30 Years</option>
              </select>
            </div>
            <div class="input-group">
              <label for="buydownType">Buydown Type</label>
              <select id="buydownType" class="input-highlight">
                <option value="3-2-1" selected>3-2-1 Buydown</option>
                <option value="2-1">2-1 Buydown</option>
                <option value="1-1">1-1 Buydown</option>
                <option value="1-0">1-0 Buydown</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Additional Options -->
        <div class="section">
          <h2>Additional Options (PITI)</h2>
          <div class="toggle-row">
            <div class="toggle-switch" id="includeTaxes" onclick="toggleOption('includeTaxes')"></div>
            <span class="toggle-label" onclick="toggleOption('includeTaxes')">Include Property Taxes</span>
          </div>
          <div class="toggle-row">
            <div class="toggle-switch" id="includeInsurance" onclick="toggleOption('includeInsurance')"></div>
            <span class="toggle-label" onclick="toggleOption('includeInsurance')">Include Homeowners Insurance</span>
          </div>
          
          <div id="taxInsuranceInputs" style="display: none; margin-top: 1rem;">
            <div class="input-grid">
              <div class="input-group">
                <label for="propertyTaxes">Annual Property Taxes ($)</label>
                <input type="number" id="propertyTaxes" value="0" min="0" step="100" class="input-highlight" />
              </div>
              <div class="input-group">
                <label for="insurance">Annual Insurance ($)</label>
                <input type="number" id="insurance" value="0" min="0" step="100" class="input-highlight" />
              </div>
              <div class="input-group">
                <label for="hoa">Monthly HOA ($)</label>
                <input type="number" id="hoa" value="0" min="0" step="25" class="input-highlight" />
              </div>
            </div>
          </div>
        </div>

        <!-- Warning Box -->
        <div id="warningBox" class="warning-box" style="display: none;"></div>

        <!-- Results Section -->
        <div class="results-section">
          <h2>Buydown Summary</h2>
          
          <div class="chips-row">
            <span class="buydown-chip" id="chipLoan">Loan: $400,000</span>
            <span class="buydown-chip" id="chipRate">Note Rate: 7.000%</span>
            <span class="buydown-chip" id="chipType">3-2-1 Buydown</span>
            <span class="buydown-chip highlight" id="chipCost">Buydown Cost: $0</span>
          </div>

          <div class="results-grid">
            <div class="result-card">
              <h3>Full Rate Payment</h3>
              <div class="result-value" id="basePayment">$0</div>
            </div>
            <div class="result-card">
              <h3>Year 1 Payment</h3>
              <div class="result-value" id="year1Payment">$0</div>
            </div>
            <div class="result-card">
              <h3>Year 1 Savings</h3>
              <div class="result-value savings-badge" id="year1Savings">$0/mo</div>
            </div>
            <div class="result-card highlight">
              <h3>Total Buydown Cost</h3>
              <div class="result-value" id="totalCost">$0</div>
            </div>
          </div>

          <!-- Year-by-Year Breakdown -->
          <h3 style="color: var(--primary); margin: 1.5rem 0 1rem;">Year-by-Year Breakdown</h3>
          <div id="yearlyBreakdown"></div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button type="button" class="btn btn-primary" onclick="showPaymentChart()">
              üìä Payment Chart
            </button>
            <button type="button" class="btn btn-secondary" onclick="showRemainingChart()">
              üìâ Remaining Chart
            </button>
            <button type="button" class="btn btn-secondary" onclick="exportCSV()">
              üìÑ Export CSV
            </button>
            <button type="button" class="btn btn-secondary" onclick="shareLink()">
              üîó Share Link
            </button>
          </div>

          <!-- Chart Container -->
          <div id="chartContainer" style="display: none;">
            <canvas id="buydownChart"></canvas>
          </div>
        </div>

        <!-- Show Calculations Section -->
        <div class="chart-section">
          <div class="chart-header" onclick="toggleMath()">
            <h2>üìê Show Calculation Steps</h2>
            <button class="chart-toggle" id="mathToggle">Show Math</button>
          </div>
          <div class="chart-content" id="mathSection">
            <div class="math-steps">
              <div class="math-step">
                <h4>Step 1: Determine Buydown Rates</h4>
                <div class="math-formula">
                  <span class="math-note">Each year's rate is reduced from the note rate:</span>
                  <div class="math-values" id="mathStep1">
                    <!-- Populated by JS -->
                  </div>
                </div>
              </div>
              
              <div class="math-step">
                <h4>Step 2: Calculate Monthly Payments at Each Rate</h4>
                <div class="math-formula">
                  Payment = Principal √ó (r / (1 - (1 + r)<sup>-n</sup>))<br>
                  <span class="math-note">where r = monthly rate, n = number of payments</span>
                  <table class="math-table" id="mathStep2">
                    <!-- Populated by JS -->
                  </table>
                </div>
              </div>
              
              <div class="math-step">
                <h4>Step 3: Calculate Monthly Savings per Year</h4>
                <div class="math-formula">
                  <span class="math-note">Savings = Full Rate Payment - Reduced Payment</span>
                  <table class="math-table" id="mathStep3">
                    <!-- Populated by JS -->
                  </table>
                </div>
              </div>
              
              <div class="math-step">
                <h4>Step 4: Calculate Total Buydown Cost</h4>
                <div class="math-formula">
                  <span class="math-note">Total Cost = Sum of (Monthly Savings √ó 12 months) for each year</span>
                  <div class="math-values" id="mathStep4">
                    <!-- Populated by JS -->
                  </div>
                </div>
              </div>

              <div class="math-step highlight">
                <h4>How Buydowns Work</h4>
                <div class="math-formula">
                  <span class="math-note">
                    A buydown is a financing technique where an upfront payment (typically from the seller, 
                    lender, or builder) is placed in an escrow account. Each month, funds are drawn from 
                    this account to subsidize the borrower's payment, making up the difference between 
                    the reduced payment and the full payment. The loan is still underwritten at the full 
                    note rate, but the borrower enjoys lower payments in the early years.
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- How It Works Footer -->
        <div class="footer">
          <div class="footer-title">Understanding Buydown Types</div>
          <p>
            <strong>3-2-1 Buydown:</strong> Year 1 rate reduced by 3%, Year 2 by 2%, Year 3 by 1%, then full rate.<br>
            <strong>2-1 Buydown:</strong> Year 1 rate reduced by 2%, Year 2 by 1%, then full rate.<br>
            <strong>1-1 Buydown:</strong> Year 1 and Year 2 rate reduced by 1%, then full rate.<br>
            <strong>1-0 Buydown:</strong> Year 1 rate reduced by 1%, then full rate.<br><br>
            Buydowns are typically funded by sellers, builders, or lenders as a closing credit. They help borrowers 
            qualify more easily and reduce payment shock in the early years of homeownership.
          </p>
        </div>

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // =====================================================
      // UTILITY FUNCTIONS
      // =====================================================
      
      function parseNum(id) {
        const val = parseFloat(document.getElementById(id).value);
        return isNaN(val) ? 0 : val;
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(amount);
      }

      function formatCurrencyDecimal(amount) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);
      }

      function formatPercent(rate) {
        return rate.toFixed(3) + '%';
      }

      // =====================================================
      // MORTGAGE CALCULATIONS
      // =====================================================
      
      function calculateMonthlyPayment(principal, annualRatePercent, years) {
        if (principal <= 0 || years <= 0) return 0;
        if (annualRatePercent <= 0) return principal / (years * 12);
        
        const monthlyRate = annualRatePercent / 100 / 12;
        const numberOfPayments = years * 12;
        
        return principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / 
               (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
      }

      // =====================================================
      // BUYDOWN CALCULATIONS
      // =====================================================
      
      function getBuydownRates(buydownType, noteRate) {
        switch (buydownType) {
          case '3-2-1':
            return {
              year1: Math.max(0, noteRate - 3),
              year2: Math.max(0, noteRate - 2),
              year3: Math.max(0, noteRate - 1),
              fullRate: noteRate,
              years: 3
            };
          case '2-1':
            return {
              year1: Math.max(0, noteRate - 2),
              year2: Math.max(0, noteRate - 1),
              year3: noteRate,
              fullRate: noteRate,
              years: 2
            };
          case '1-1':
            return {
              year1: Math.max(0, noteRate - 1),
              year2: Math.max(0, noteRate - 1),
              year3: noteRate,
              fullRate: noteRate,
              years: 2
            };
          case '1-0':
            return {
              year1: Math.max(0, noteRate - 1),
              year2: noteRate,
              year3: noteRate,
              fullRate: noteRate,
              years: 1
            };
          default:
            return {
              year1: noteRate,
              year2: noteRate,
              year3: noteRate,
              fullRate: noteRate,
              years: 0
            };
        }
      }

      function calculateBuydownResults(state) {
        const rates = getBuydownRates(state.buydownType, state.noteRate);
        const fullPayment = calculateMonthlyPayment(state.loanAmount, rates.fullRate, state.loanTerm);
        
        // Calculate payments and savings for each year
        const years = [];
        let totalCost = 0;
        
        for (let i = 1; i <= 3; i++) {
          const rate = rates[`year${i}`];
          const piPayment = calculateMonthlyPayment(state.loanAmount, rate, state.loanTerm);
          const monthlySavings = fullPayment - piPayment;
          const yearlySavings = monthlySavings * 12;
          
          // Add taxes/insurance/HOA if enabled
          let totalPayment = piPayment;
          if (state.includeTaxes) totalPayment += state.propertyTaxes / 12;
          if (state.includeInsurance) totalPayment += state.insurance / 12;
          totalPayment += state.hoa;
          
          // Only count savings for years that are actually reduced
          if (rate < rates.fullRate) {
            totalCost += yearlySavings;
          }
          
          years.push({
            year: i,
            rate: rate,
            piPayment: piPayment,
            totalPayment: totalPayment,
            monthlySavings: monthlySavings,
            yearlySavings: yearlySavings,
            isReduced: rate < rates.fullRate
          });
        }
        
        // Full rate year (year 4+)
        let fullTotalPayment = fullPayment;
        if (state.includeTaxes) fullTotalPayment += state.propertyTaxes / 12;
        if (state.includeInsurance) fullTotalPayment += state.insurance / 12;
        fullTotalPayment += state.hoa;
        
        years.push({
          year: 4,
          rate: rates.fullRate,
          piPayment: fullPayment,
          totalPayment: fullTotalPayment,
          monthlySavings: 0,
          yearlySavings: 0,
          isReduced: false
        });
        
        return {
          rates: rates,
          years: years,
          fullPayment: fullPayment,
          fullTotalPayment: fullTotalPayment,
          totalCost: totalCost
        };
      }

      // =====================================================
      // STATE MANAGEMENT
      // =====================================================
      
      function getCurrentState() {
        return {
          loanAmount: parseNum('loanAmount'),
          noteRate: parseNum('noteRate'),
          loanTerm: parseInt(document.getElementById('loanTerm').value),
          buydownType: document.getElementById('buydownType').value,
          includeTaxes: document.getElementById('includeTaxes').classList.contains('active'),
          includeInsurance: document.getElementById('includeInsurance').classList.contains('active'),
          propertyTaxes: parseNum('propertyTaxes'),
          insurance: parseNum('insurance'),
          hoa: parseNum('hoa')
        };
      }

      function toggleOption(id) {
        const el = document.getElementById(id);
        el.classList.toggle('active');
        
        // Show/hide tax inputs
        const taxInputs = document.getElementById('taxInsuranceInputs');
        const showInputs = document.getElementById('includeTaxes').classList.contains('active') ||
                          document.getElementById('includeInsurance').classList.contains('active');
        taxInputs.style.display = showInputs ? 'block' : 'none';
        
        calculate();
      }

      // =====================================================
      // VALIDATION
      // =====================================================
      
      function validateAndWarn(state) {
        const warningBox = document.getElementById('warningBox');
        
        // Check for negative rates
        const minRate = state.buydownType === '3-2-1' ? 3 : 
                       state.buydownType === '2-1' ? 2 : 1;
        
        if (state.noteRate < minRate && state.noteRate > 0) {
          warningBox.innerHTML = `‚ö†Ô∏è <strong>Warning:</strong> Note rate (${formatPercent(state.noteRate)}) is lower than the ${state.buydownType} buydown reduction. Year 1 rate will be floored at 0%.`;
          warningBox.className = 'warning-box';
          warningBox.style.display = 'block';
          return true;
        }
        
        if (state.loanAmount <= 0 || state.noteRate <= 0) {
          warningBox.style.display = 'none';
          return false;
        }
        
        warningBox.style.display = 'none';
        return true;
      }

      // =====================================================
      // MAIN CALCULATION & RENDER
      // =====================================================
      
      function calculate() {
        const state = getCurrentState();
        
        // Validate
        if (state.loanAmount <= 0 || state.noteRate <= 0) {
          return;
        }
        
        validateAndWarn(state);
        
        const results = calculateBuydownResults(state);
        
        // Update chips
        document.getElementById('chipLoan').textContent = `Loan: ${formatCurrency(state.loanAmount)}`;
        document.getElementById('chipRate').textContent = `Note Rate: ${formatPercent(state.noteRate)}`;
        document.getElementById('chipType').textContent = `${state.buydownType} Buydown`;
        document.getElementById('chipCost').textContent = `Buydown Cost: ${formatCurrency(results.totalCost)}`;
        
        // Update summary cards
        document.getElementById('basePayment').textContent = formatCurrencyDecimal(results.fullTotalPayment);
        document.getElementById('year1Payment').textContent = formatCurrencyDecimal(results.years[0].totalPayment);
        document.getElementById('year1Savings').textContent = formatCurrency(results.years[0].monthlySavings) + '/mo';
        document.getElementById('totalCost').textContent = formatCurrency(results.totalCost);
        
        // Render year-by-year breakdown
        renderYearlyBreakdown(results, state);
        
        // Update math steps
        updateMathSteps(state, results);
        
        // Update URL
        updateURL(state);
      }

      function renderYearlyBreakdown(results, state) {
        const container = document.getElementById('yearlyBreakdown');
        container.innerHTML = '';
        
        // Determine which years to show
        let yearsToShow = [];
        if (state.buydownType === '3-2-1') {
          yearsToShow = [0, 1, 2, 3];
        } else if (state.buydownType === '2-1') {
          yearsToShow = [0, 1, 3];
        } else if (state.buydownType === '1-1') {
          yearsToShow = [0, 1, 3];
        } else {
          yearsToShow = [0, 3];
        }
        
        yearsToShow.forEach(index => {
          const year = results.years[index];
          const isFullRate = !year.isReduced && year.year > 1;
          
          const card = document.createElement('div');
          card.className = 'year-card' + (isFullRate ? ' full-rate' : '');
          
          const yearLabel = isFullRate ? 'Full Rate (Year 4+)' : `Year ${year.year}`;
          
          let gridHTML = `
            <div class="year-item">
              <div class="label">P&I Payment</div>
              <div class="value">${formatCurrencyDecimal(year.piPayment)}</div>
            </div>
          `;
          
          if (state.includeTaxes) {
            gridHTML += `
              <div class="year-item">
                <div class="label">Taxes</div>
                <div class="value">${formatCurrency(state.propertyTaxes / 12)}</div>
              </div>
            `;
          }
          
          if (state.includeInsurance) {
            gridHTML += `
              <div class="year-item">
                <div class="label">Insurance</div>
                <div class="value">${formatCurrency(state.insurance / 12)}</div>
              </div>
            `;
          }
          
          if (state.hoa > 0) {
            gridHTML += `
              <div class="year-item">
                <div class="label">HOA</div>
                <div class="value">${formatCurrency(state.hoa)}</div>
              </div>
            `;
          }
          
          gridHTML += `
            <div class="year-item">
              <div class="label">Total Payment</div>
              <div class="value">${formatCurrencyDecimal(year.totalPayment)}</div>
            </div>
          `;
          
          if (year.isReduced) {
            gridHTML += `
              <div class="year-item">
                <div class="label">Monthly Savings</div>
                <div class="value savings-badge">${formatCurrency(year.monthlySavings)}</div>
              </div>
            `;
          }
          
          card.innerHTML = `
            <h4>
              ${yearLabel}
              <span class="rate-badge">${formatPercent(year.rate)}</span>
            </h4>
            <div class="year-grid">${gridHTML}</div>
          `;
          
          container.appendChild(card);
        });
      }

      // =====================================================
      // MATH STEPS
      // =====================================================
      
      function updateMathSteps(state, results) {
        // Step 1: Buydown Rates
        let step1HTML = '';
        if (state.buydownType === '3-2-1') {
          step1HTML = `
            Year 1: ${formatPercent(state.noteRate)} - 3% = <strong>${formatPercent(results.rates.year1)}</strong><br>
            Year 2: ${formatPercent(state.noteRate)} - 2% = <strong>${formatPercent(results.rates.year2)}</strong><br>
            Year 3: ${formatPercent(state.noteRate)} - 1% = <strong>${formatPercent(results.rates.year3)}</strong><br>
            Year 4+: Full rate = <strong>${formatPercent(results.rates.fullRate)}</strong>
          `;
        } else if (state.buydownType === '2-1') {
          step1HTML = `
            Year 1: ${formatPercent(state.noteRate)} - 2% = <strong>${formatPercent(results.rates.year1)}</strong><br>
            Year 2: ${formatPercent(state.noteRate)} - 1% = <strong>${formatPercent(results.rates.year2)}</strong><br>
            Year 3+: Full rate = <strong>${formatPercent(results.rates.fullRate)}</strong>
          `;
        } else if (state.buydownType === '1-1') {
          step1HTML = `
            Year 1: ${formatPercent(state.noteRate)} - 1% = <strong>${formatPercent(results.rates.year1)}</strong><br>
            Year 2: ${formatPercent(state.noteRate)} - 1% = <strong>${formatPercent(results.rates.year2)}</strong><br>
            Year 3+: Full rate = <strong>${formatPercent(results.rates.fullRate)}</strong>
          `;
        } else {
          step1HTML = `
            Year 1: ${formatPercent(state.noteRate)} - 1% = <strong>${formatPercent(results.rates.year1)}</strong><br>
            Year 2+: Full rate = <strong>${formatPercent(results.rates.fullRate)}</strong>
          `;
        }
        document.getElementById('mathStep1').innerHTML = step1HTML;
        
        // Step 2: Monthly Payments
        let step2HTML = `
          <tr>
            <th>Period</th>
            <th>Rate</th>
            <th>Monthly Payment</th>
          </tr>
        `;
        
        const yearsToShow = state.buydownType === '3-2-1' ? [0, 1, 2, 3] :
                           state.buydownType === '2-1' ? [0, 1, 3] : 
                           state.buydownType === '1-1' ? [0, 1, 3] : [0, 3];
        
        yearsToShow.forEach(i => {
          const year = results.years[i];
          const label = year.year === 4 ? 'Full Rate' : `Year ${year.year}`;
          step2HTML += `
            <tr>
              <td>${label}</td>
              <td>${formatPercent(year.rate)}</td>
              <td>${formatCurrencyDecimal(year.piPayment)}</td>
            </tr>
          `;
        });
        document.getElementById('mathStep2').innerHTML = step2HTML;
        
        // Step 3: Monthly Savings
        let step3HTML = `
          <tr>
            <th>Year</th>
            <th>Full Payment</th>
            <th>Reduced Payment</th>
            <th>Monthly Savings</th>
            <th>Annual Savings</th>
          </tr>
        `;
        
        results.years.slice(0, 3).forEach(year => {
          if (year.isReduced) {
            step3HTML += `
              <tr>
                <td>Year ${year.year}</td>
                <td>${formatCurrencyDecimal(results.fullPayment)}</td>
                <td>${formatCurrencyDecimal(year.piPayment)}</td>
                <td>${formatCurrencyDecimal(year.monthlySavings)}</td>
                <td>${formatCurrency(year.yearlySavings)}</td>
              </tr>
            `;
          }
        });
        document.getElementById('mathStep3').innerHTML = step3HTML;
        
        // Step 4: Total Cost
        let costBreakdown = '';
        let runningTotal = 0;
        results.years.slice(0, 3).forEach(year => {
          if (year.isReduced) {
            costBreakdown += `Year ${year.year}: ${formatCurrency(year.yearlySavings)}<br>`;
            runningTotal += year.yearlySavings;
          }
        });
        costBreakdown += `<br><strong>Total Buydown Cost: ${formatCurrency(results.totalCost)}</strong>`;
        document.getElementById('mathStep4').innerHTML = costBreakdown;
      }

      function toggleMath() {
        const section = document.getElementById('mathSection');
        const toggle = document.getElementById('mathToggle');
        
        if (section.classList.contains('open')) {
          section.classList.remove('open');
          toggle.textContent = 'Show Math';
        } else {
          section.classList.add('open');
          toggle.textContent = 'Hide Math';
        }
      }

      // =====================================================
      // CHARTS
      // =====================================================
      
      let currentChart = null;

      function showPaymentChart() {
        const state = getCurrentState();
        const results = calculateBuydownResults(state);
        
        const ctx = document.getElementById('buydownChart').getContext('2d');
        
        if (currentChart) currentChart.destroy();
        
        const labels = [];
        const payments = [];
        const colors = [];
        
        const yearsToShow = state.buydownType === '3-2-1' ? [0, 1, 2, 3] :
                           state.buydownType === '2-1' ? [0, 1, 3] : 
                           state.buydownType === '1-1' ? [0, 1, 3] : [0, 3];
        
        yearsToShow.forEach(i => {
          const year = results.years[i];
          labels.push(year.year === 4 ? 'Full Rate' : `Year ${year.year}`);
          payments.push(year.totalPayment);
          colors.push(year.isReduced ? 'rgba(45, 106, 79, 0.8)' : 'rgba(64, 145, 108, 0.8)');
        });
        
        currentChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Monthly Payment',
              data: payments,
              backgroundColor: colors,
              borderColor: colors.map(c => c.replace('0.8', '1')),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: 'Monthly Payment by Year',
                font: { size: 16 }
              },
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: value => '$' + value.toLocaleString()
                }
              }
            }
          }
        });
        
        document.getElementById('chartContainer').style.display = 'block';
      }

      function showRemainingChart() {
        const state = getCurrentState();
        const results = calculateBuydownResults(state);
        
        const ctx = document.getElementById('buydownChart').getContext('2d');
        
        if (currentChart) currentChart.destroy();
        
        const labels = [];
        const remaining = [];
        const totalMonths = state.buydownType === '3-2-1' ? 36 :
                           state.buydownType === '2-1' ? 24 : 12;
        
        for (let month = 0; month <= totalMonths; month++) {
          labels.push(month === 0 ? 'Start' : `Mo ${month}`);
          
          let used = 0;
          if (month <= 12) {
            used = results.years[0].monthlySavings * month;
          } else if (month <= 24) {
            used = results.years[0].yearlySavings + results.years[1].monthlySavings * (month - 12);
          } else {
            used = results.years[0].yearlySavings + results.years[1].yearlySavings + 
                   results.years[2].monthlySavings * (month - 24);
          }
          
          remaining.push(Math.max(0, results.totalCost - used));
        }
        
        currentChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Buydown Remaining',
              data: remaining,
              borderColor: 'rgba(45, 106, 79, 1)',
              backgroundColor: 'rgba(45, 106, 79, 0.2)',
              borderWidth: 3,
              fill: true,
              tension: 0.1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: 'Buydown Credit Remaining',
                font: { size: 16 }
              },
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: value => '$' + value.toLocaleString()
                }
              },
              x: {
                ticks: {
                  maxTicksLimit: 12
                }
              }
            }
          }
        });
        
        document.getElementById('chartContainer').style.display = 'block';
      }

      // =====================================================
      // URL STATE & EXPORT
      // =====================================================
      
      function serializeState(state) {
        return new URLSearchParams({
          la: state.loanAmount,
          nr: state.noteRate,
          lt: state.loanTerm,
          bt: state.buydownType,
          it: state.includeTaxes ? '1' : '0',
          ii: state.includeInsurance ? '1' : '0',
          pt: state.propertyTaxes,
          ins: state.insurance,
          hoa: state.hoa
        }).toString();
      }

      function deserializeState(params) {
        return {
          loanAmount: parseFloat(params.get('la')) || 400000,
          noteRate: parseFloat(params.get('nr')) || 7,
          loanTerm: parseInt(params.get('lt')) || 30,
          buydownType: params.get('bt') || '3-2-1',
          includeTaxes: params.get('it') === '1',
          includeInsurance: params.get('ii') === '1',
          propertyTaxes: parseFloat(params.get('pt')) || 0,
          insurance: parseFloat(params.get('ins')) || 0,
          hoa: parseFloat(params.get('hoa')) || 0
        };
      }

      function updateURL(state) {
        const url = new URL(window.location);
        url.search = serializeState(state);
        window.history.replaceState({}, '', url);
      }

      function loadFromURL() {
        const params = new URLSearchParams(window.location.search);
        if (params.toString()) {
          const state = deserializeState(params);
          
          document.getElementById('loanAmount').value = state.loanAmount;
          document.getElementById('noteRate').value = state.noteRate;
          document.getElementById('loanTerm').value = state.loanTerm;
          document.getElementById('buydownType').value = state.buydownType;
          
          if (state.includeTaxes) document.getElementById('includeTaxes').classList.add('active');
          if (state.includeInsurance) document.getElementById('includeInsurance').classList.add('active');
          
          document.getElementById('propertyTaxes').value = state.propertyTaxes;
          document.getElementById('insurance').value = state.insurance;
          document.getElementById('hoa').value = state.hoa;
          
          if (state.includeTaxes || state.includeInsurance) {
            document.getElementById('taxInsuranceInputs').style.display = 'block';
          }
        }
      }

      function exportCSV() {
        const state = getCurrentState();
        const results = calculateBuydownResults(state);
        
        const lines = [
          ['Buydown Calculator Results', ''],
          ['', ''],
          ['Loan Information', ''],
          ['Loan Amount', formatCurrency(state.loanAmount)],
          ['Note Rate', formatPercent(state.noteRate)],
          ['Loan Term', state.loanTerm + ' years'],
          ['Buydown Type', state.buydownType],
          ['', ''],
          ['Year-by-Year Breakdown', '', '', ''],
          ['Year', 'Rate', 'P&I Payment', 'Total Payment'],
          ...results.years.map(y => [
            y.year === 4 ? 'Full Rate' : `Year ${y.year}`,
            formatPercent(y.rate),
            formatCurrencyDecimal(y.piPayment),
            formatCurrencyDecimal(y.totalPayment)
          ]),
          ['', ''],
          ['Summary', ''],
          ['Year 1 Monthly Savings', formatCurrency(results.years[0].monthlySavings)],
          ['Total Buydown Cost', formatCurrency(results.totalCost)],
          ['', ''],
          ['Generated', new Date().toLocaleString()]
        ];
        
        const csv = lines.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `buydown-calculator-${Date.now()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function shareLink() {
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('Link copied to clipboard!');
        });
      }

      // =====================================================
      // EVENT LISTENERS
      // =====================================================
      
      function wireEvents() {
        const inputs = ['loanAmount', 'noteRate', 'loanTerm', 'buydownType', 
                       'propertyTaxes', 'insurance', 'hoa'];
        inputs.forEach(id => {
          document.getElementById(id).addEventListener('input', calculate);
          document.getElementById(id).addEventListener('change', calculate);
        });
      }

      // =====================================================
      // INITIALIZE
      // =====================================================
      
      document.addEventListener('DOMContentLoaded', () => {
        wireEvents();
        loadFromURL();
        calculate();
      });
    </script>
  </body>
</html>
