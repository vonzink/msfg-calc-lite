<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSFG ‚Ä¢ FHA Refinance Calculator</title>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        body { padding: 0; }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--light);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .logo { display: flex; align-items: center; gap: 1rem; }
        .logo img { height: 60px; width: auto; }
        .logo h1 { margin: 0; font-size: 1.8rem; font-weight: 300; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; }
        
        .description {
            text-align: center;
            color: var(--gray);
            max-width: 800px;
            margin: 0 auto 2rem;
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .input-highlight {
            background: var(--light) !important;
            border: 2px solid var(--accent) !important;
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }
        
        .alert.error {
            background: #ffebee;
            border-left-color: #c62828;
            color: #c62828;
        }
        
        .alert.warning {
            background: #fff3e0;
            border-left-color: #e65100;
            color: #e65100;
        }
        
        .alert.success {
            background: #e8f5e9;
            border-left-color: #2e7d32;
            color: #2e7d32;
        }
        
        .alert strong { display: block; margin-bottom: 0.25rem; }
        
        .refund-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .refund-table th,
        .refund-table td {
            border: 1px solid var(--border);
            padding: 0.5rem;
            text-align: center;
        }
        
        .refund-table th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--primary);
        }
        
        .refund-table input {
            width: 60px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.25rem;
        }
        
        .refund-table tr:hover {
            background: var(--light-gray);
        }
        
        .date-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .seasoning-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .status-card {
            padding: 1rem;
            border-radius: 6px;
            border: 2px solid;
        }
        
        .status-card.pass {
            background: #e8f5e9;
            border-color: #2e7d32;
        }
        
        .status-card.fail {
            background: #ffebee;
            border-color: #c62828;
        }
        
        .status-card .label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }
        
        .status-card .value {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .ntb-section {
            background: var(--light-gray);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }
        
        .ntb-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .input-block {
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .input-block h3 {
            color: var(--primary);
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
        }
        
        .calculation-row {
            display: grid;
            grid-template-columns: 2fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        .calculation-row.add {
            background: #e8f5e9;
        }
        
        .calculation-row.subtract {
            background: #ffebee;
        }
        
        .calculation-row label {
            font-weight: 600;
            color: var(--dark);
        }
        
        .calculation-row .operator {
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .subtotal-row {
            background: var(--light-gray);
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 1rem;
            border: 2px solid var(--accent);
        }
        
        .subtotal-row .label {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .subtotal-row .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .final-result {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: var(--light);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 2rem;
        }
        
        .final-result h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .final-result .value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .final-result .note {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="https://msfg-media.s3.us-west-2.amazonaws.com/Assets/LOGOS/Compass/Compass+Home+Loan+-+Color+Transparent+Background.png" alt="MSFG Logo">
            <h1>FHA Refinance Calculator</h1>
        </div>
    </header>

    <div class="container">
        <p class="description" style="text-align: center; color: var(--gray); max-width: 800px; margin: 0 auto 2rem;">
            Calculate maximum mortgage amounts for FHA refinance transactions with accurate seasoning, UFMIP refunds, and Net Tangible Benefit validation.
        </p>

        <!-- Seasoning Validation Alert (shown when fails) -->
        <div id="seasoningAlert" class="alert error" style="display: none;">
            <strong>‚ö†Ô∏è Seasoning Requirements Not Met</strong>
            <span id="seasoningMessage"></span>
        </div>

        <!-- Borrower Information -->
        <div class="section">
            <h2>Borrower Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Borrower Name</label>
                    <input type="text" id="borrowerName" placeholder="Enter borrower name">
                </div>
                <div class="form-group">
                    <label>Loan Number</label>
                    <input type="text" id="loanNumber" placeholder="Enter loan number">
                </div>
                <div class="form-group">
                    <label>FHA Case ID</label>
                    <input type="text" id="caseId" placeholder="Enter FHA case ID">
                </div>
            </div>
        </div>

        <!-- Date Tracking & Seasoning -->
        <div class="section">
            <h2>üìÖ Loan Dates & Seasoning</h2>
            <div class="date-grid">
                <div class="form-group">
                    <label>FHA Endorsement Date</label>
                    <input type="date" id="endorsementDate" onchange="validateSeasoning()">
                    <small style="color: var(--gray);">Original FHA loan endorsement date</small>
                </div>
                <div class="form-group">
                    <label>First Payment Due Date</label>
                    <input type="date" id="firstPaymentDate" onchange="validateSeasoning()">
                    <small style="color: var(--gray);">Date of first payment on existing loan</small>
                </div>
                <div class="form-group">
                    <label>Current Date / Payoff Date</label>
                    <input type="date" id="currentDate" onchange="validateSeasoning()">
                    <small style="color: var(--gray);">Today's date (auto-populated)</small>
                </div>
            </div>

            <!-- Seasoning Status -->
            <div class="seasoning-status">
                <div class="status-card" id="paymentsCard">
                    <div class="label">Payments Made</div>
                    <div class="value" id="paymentsMade">‚Äî</div>
                    <small id="paymentsStatus" style="margin-top: 0.5rem; display: block;"></small>
                </div>
                <div class="status-card" id="daysCard">
                    <div class="label">Days Since First Payment</div>
                    <div class="value" id="daysSince">‚Äî</div>
                    <small id="daysStatus" style="margin-top: 0.5rem; display: block;"></small>
                </div>
            </div>
        </div>

        <!-- UFMIP Refund Table -->
        <div class="section">
            <h2>üí∞ UFMIP Refund Table</h2>
            <p style="color: var(--gray); margin-bottom: 1rem;">
                Refund applies only if the existing FHA loan was endorsed on/after <strong>September 1, 1983</strong>. 
                Refund percentage is based on months after the original loan closing. Table values are editable.
            </p>
            
            <div style="overflow-x: auto;">
                <table class="refund-table" id="refundTable">
                    <thead>
                        <tr>
                            <th>Months After Closing</th>
                            <th>MIP Refund</th>
                            <th>Months After Closing</th>
                            <th>MIP Refund</th>
                            <th>Months After Closing</th>
                            <th>MIP Refund</th>
                        </tr>
                    </thead>
                    <tbody id="refundTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 1rem;">
                <button class="btn" onclick="resetRefundTable()">Reset to Default Values</button>
            </div>
        </div>

        <!-- Streamline Refinance Section (Enhanced) -->
        <div class="section">
            <h2>üè† FHA Streamline Refinance (No Appraisal)</h2>
            
            <!-- Property Type -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Property Type</label>
                <div style="display: flex; gap: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="radio" name="propertyType" value="primary" checked onchange="calculateStreamline()">
                        <span>Primary Residence</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="radio" name="propertyType" value="investment" onchange="calculateStreamline()">
                        <span>Investment Property</span>
                    </label>
                </div>
            </div>

            <div class="input-block">
                <h3>Step 1: Unpaid Principal Balance (UPB)</h3>
                <div class="calculation-row add">
                    <label>Current UPB from Servicer Payoff</label>
                    <div class="operator"></div>
                    <input type="number" id="sl_upb" value="0" oninput="calculateStreamline()" class="input-highlight">
                </div>
                <p style="color: var(--gray); font-size: 0.85rem; margin-top: 0.5rem;">
                    This is the anchor - must come from official payoff statement
                </p>
            </div>

            <div class="input-block">
                <h3>Step 2: UFMIP Refund (if applicable)</h3>
                <div style="margin-bottom: 1rem;">
                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">Original FHA Loan Amount</label>
                    <input type="number" id="sl_originalLoanAmount" value="0" oninput="calculateStreamline()" style="width: 200px; display: inline-block;">
                    <small style="display: block; margin-top: 0.25rem; color: var(--gray);">
                        Base loan amount from original FHA loan (not including UFMIP). UFMIP will be calculated at 1.75%.
                    </small>
                </div>
                <div class="calculation-row subtract">
                    <label>UFMIP Refund Amount</label>
                    <div class="operator">-</div>
                    <input type="text" id="sl_ufmipRefund" readonly style="background: var(--light-gray);">
                </div>
                <p style="color: var(--gray); font-size: 0.85rem; margin-top: 0.5rem;">
                    Auto-calculated: Original Loan √ó 1.75% √ó Refund% from table. Only if endorsed after 9/1/1983.
                </p>
            </div>

            <div class="input-block">
                <h3>Step 3: Accrued Interest (if applicable)</h3>
                <div class="calculation-row add">
                    <label>Accrued Interest Due</label>
                    <div class="operator">+</div>
                    <input type="number" id="sl_accruedInterest" value="0" oninput="calculateStreamline()" class="input-highlight">
                </div>
                <p style="color: var(--gray); font-size: 0.85rem; margin-top: 0.5rem;">
                    Only if payoff is on/after payment due date. Do NOT include per diem beyond payoff.
                </p>
            </div>

            <div class="input-block">
                <h3>Step 4: Allowable Closing Costs (Itemized)</h3>
                <p style="color: var(--gray); margin-bottom: 1rem; font-size: 0.9rem;">
                    Enter each allowable closing cost. These can be financed into the loan.
                </p>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <div style="font-weight: 600; color: var(--primary);">Cost Item</div>
                    <div style="font-weight: 600; color: var(--primary);">Amount</div>
                </div>
                
                <!-- Lender Fees -->
                <div style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">Lender Fees</div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center;">
                        <label>Origination Fee</label>
                        <input type="number" id="cost_origination" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Processing Fee</label>
                        <input type="number" id="cost_processing" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Underwriting Fee</label>
                        <input type="number" id="cost_underwriting" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Discount Points (if any)</label>
                        <input type="number" id="cost_points" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                </div>
                
                <!-- Third Party Fees -->
                <div style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">Third Party Fees</div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center;">
                        <label>Credit Report Fee</label>
                        <input type="number" id="cost_credit" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Flood Certification</label>
                        <input type="number" id="cost_flood" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Inspection Fee (if required)</label>
                        <input type="number" id="cost_inspection" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                </div>
                
                <!-- Title & Recording -->
                <div style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">Title & Recording</div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center;">
                        <label>Title Search / Exam</label>
                        <input type="number" id="cost_title_search" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Title Insurance</label>
                        <input type="number" id="cost_title_insurance" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Recording Fees</label>
                        <input type="number" id="cost_recording" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Attorney / Settlement Fee</label>
                        <input type="number" id="cost_attorney" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                </div>
                
                <!-- Other Allowed -->
                <div style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary);">Other Allowed Costs</div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center;">
                        <label>Survey (if required)</label>
                        <input type="number" id="cost_survey" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Pest Inspection (if required)</label>
                        <input type="number" id="cost_pest" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                        <label>Other Streamline-Allowed Costs</label>
                        <input type="number" id="cost_other" value="0" oninput="calculateStreamline()" class="input-highlight" style="width: 100%;">
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding: 0.75rem; background: #e8f5e9; border-radius: 6px; border: 2px solid var(--accent);">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Total Closing Costs</div>
                    <div style="font-size: 1.3rem; font-weight: 700; color: var(--primary);" id="sl_totalClosingCosts">$0.00</div>
                </div>
                
                <p style="color: var(--warning); font-size: 0.85rem; margin-top: 1rem; font-weight: 600;">
                    ‚ö†Ô∏è CANNOT FINANCE: Late fees, escrows, prepaids (taxes/insurance/interest), or payoffs other than existing FHA loan
                </p>
            </div>

            <div class="subtotal-row">
                <div class="label">Base Loan Amount (Before New UFMIP)</div>
                <div class="value" id="sl_baseAmount">$0.00</div>
            </div>

            <div class="calculation-row add" style="margin-top: 1rem;">
                <label>NEW UFMIP (1.75% of Base)</label>
                <div class="operator">+</div>
                <input type="text" id="sl_newUFMIP" readonly style="background: var(--light-gray);">
            </div>

            <div class="final-result">
                <h3>Maximum Streamline Mortgage</h3>
                <div class="value" id="sl_finalResult">$0.00</div>
                <div class="note">UPB - UFMIP Refund + Interest + Costs + New UFMIP (1.75%)</div>
            </div>
        </div>

        <!-- Net Tangible Benefit Test -->
        <div class="section ntb-section">
            <h2>‚úÖ Net Tangible Benefit (NTB) Test</h2>
            <p style="color: var(--gray); margin-bottom: 1rem;">
                This is a gatekeeper - even if the loan math works, the deal dies if NTB fails.
            </p>

            <div class="ntb-grid">
                <!-- Existing Loan -->
                <div>
                    <h3 style="margin-bottom: 1rem;">Existing FHA Loan</h3>
                    <div class="form-group">
                        <label>Current Interest Rate (%)</label>
                        <input type="number" id="ntb_oldRate" step="0.001" placeholder="e.g., 6.500" oninput="checkNTB()">
                    </div>
                    <div class="form-group">
                        <label>Current P&I Payment</label>
                        <input type="number" id="ntb_oldPayment" placeholder="e.g., 2500" oninput="checkNTB()">
                    </div>
                    <div class="form-group">
                        <label>Loan Type</label>
                        <select id="ntb_oldType" onchange="checkNTB()">
                            <option value="fixed">Fixed Rate</option>
                            <option value="arm">ARM</option>
                        </select>
                    </div>
                </div>

                <!-- New Loan -->
                <div>
                    <h3 style="margin-bottom: 1rem;">New FHA Streamline</h3>
                    <div class="form-group">
                        <label>New Interest Rate (%)</label>
                        <input type="number" id="ntb_newRate" step="0.001" placeholder="e.g., 5.750" oninput="checkNTB()">
                    </div>
                    <div class="form-group">
                        <label>New P&I Payment</label>
                        <input type="number" id="ntb_newPayment" placeholder="e.g., 2350" oninput="checkNTB()">
                    </div>
                    <div class="form-group">
                        <label>Loan Type</label>
                        <select id="ntb_newType" onchange="checkNTB()">
                            <option value="fixed">Fixed Rate</option>
                            <option value="arm">ARM</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- NTB Results -->
            <div id="ntbResults" style="margin-top: 1.5rem; display: none;">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <div class="footer">
            <div class="footer-title">Important FHA Streamline Rules</div>
            <p><strong>Seasoning:</strong> Must have made 6 payments AND 210 days since first payment due date.</p>
            <p><strong>UFMIP Refund:</strong> Only for loans endorsed after Sept 1, 1983. Refund credited to reduce new UFMIP, not cash to borrower.</p>
            <p><strong>Financed Costs:</strong> Only standard streamline-allowed closing costs. NO late fees, escrows, prepaids, or other payoffs.</p>
            <p><strong>NTB Test:</strong> Net Tangible Benefit must be demonstrated. Rate and payment limits apply based on loan type transitions.</p>
        </div>
    </div>

    <script>
        // FHA Streamline Calculator with Seasoning & UFMIP Refund
        
        // Actual HUD UFMIP Refund Table (February 2026)
        const DEFAULT_REFUND_TABLE = [
            { months: 1, refund: 80 },
            { months: 2, refund: 78 },
            { months: 3, refund: 76 },
            { months: 4, refund: 74 },
            { months: 5, refund: 72 },
            { months: 6, refund: 70 },
            { months: 7, refund: 68 },
            { months: 8, refund: 66 },
            { months: 9, refund: 64 },
            { months: 10, refund: 62 },
            { months: 11, refund: 60 },
            { months: 12, refund: 58 },
            { months: 13, refund: 56 },
            { months: 14, refund: 54 },
            { months: 15, refund: 52 },
            { months: 16, refund: 50 },
            { months: 17, refund: 48 },
            { months: 18, refund: 46 },
            { months: 19, refund: 44 },
            { months: 20, refund: 42 },
            { months: 21, refund: 40 },
            { months: 22, refund: 38 },
            { months: 23, refund: 36 },
            { months: 24, refund: 34 },
            { months: 25, refund: 32 },
            { months: 26, refund: 30 },
            { months: 27, refund: 28 },
            { months: 28, refund: 26 },
            { months: 29, refund: 24 },
            { months: 30, refund: 22 },
            { months: 31, refund: 20 },
            { months: 32, refund: 18 },
            { months: 33, refund: 16 },
            { months: 34, refund: 14 },
            { months: 35, refund: 12 },
            { months: 36, refund: 10 },
            { months: 37, refund: 0 }  // 37+ months = no refund
        ];
        
        let refundTable = [...DEFAULT_REFUND_TABLE];
        
        // Utility Functions
        function formatCurrency(num) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }
        
        function parseNum(val) {
            const n = parseFloat(val);
            return isNaN(n) ? 0 : n;
        }
        
        function monthsBetween(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return Math.max(0, (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth()));
        }
        
        function daysBetween(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diff = d2 - d1;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('currentDate').value = today;
            
            // Populate refund table
            populateRefundTable();
        });
        
        // Populate UFMIP Refund Table
        function populateRefundTable() {
            const tbody = document.getElementById('refundTableBody');
            tbody.innerHTML = '';
            
            // Create rows in groups of 3 columns (each showing month + refund %)
            for (let i = 0; i < refundTable.length; i += 3) {
                const row = document.createElement('tr');
                
                for (let j = 0; j < 3; j++) {
                    const index = i + j;
                    if (index < refundTable.length) {
                        const item = refundTable[index];
                        const monthLabel = item.months >= 37 ? '37+' : item.months;
                        row.innerHTML += `
                            <td>Month ${monthLabel}</td>
                            <td>
                                <input type="number" 
                                       value="${item.refund}" 
                                       min="0" 
                                       max="100" 
                                       step="1"
                                       onchange="updateRefundTable(${index}, this.value)"
                                       style="width: 60px;">%
                            </td>
                        `;
                    } else {
                        row.innerHTML += '<td></td><td></td>';
                    }
                }
                
                tbody.appendChild(row);
            }
        }
        
        function updateRefundTable(index, value) {
            refundTable[index].refund = parseFloat(value) || 0;
            calculateStreamline();
        }
        
        function resetRefundTable() {
            refundTable = [...DEFAULT_REFUND_TABLE];
            populateRefundTable();
            calculateStreamline();
        }
        
        // Validate Seasoning Requirements
        function validateSeasoning() {
            const endorsementDate = document.getElementById('endorsementDate').value;
            const firstPaymentDate = document.getElementById('firstPaymentDate').value;
            const currentDate = document.getElementById('currentDate').value;
            
            if (!endorsementDate || !firstPaymentDate || !currentDate) {
                // Clear status if dates not set
                document.getElementById('paymentsMade').textContent = '‚Äî';
                document.getElementById('daysSince').textContent = '‚Äî';
                document.getElementById('paymentsStatus').textContent = '';
                document.getElementById('daysStatus').textContent = '';
                document.getElementById('seasoningAlert').style.display = 'none';
                return;
            }
            
            // Calculate payments made (months between first payment and current date)
            const paymentsMade = monthsBetween(firstPaymentDate, currentDate);
            
            // Calculate days since first payment
            const daysSinceFirst = daysBetween(firstPaymentDate, currentDate);
            
            // Check if seasoning requirements are met
            const paymentsPass = paymentsMade >= 6;
            const daysPass = daysSinceFirst >= 210;
            
            // Update UI
            document.getElementById('paymentsMade').textContent = paymentsMade;
            document.getElementById('daysSince').textContent = daysSinceFirst;
            
            // Update status cards
            const paymentsCard = document.getElementById('paymentsCard');
            const daysCard = document.getElementById('daysCard');
            
            if (paymentsPass) {
                paymentsCard.classList.remove('fail');
                paymentsCard.classList.add('pass');
                document.getElementById('paymentsStatus').textContent = '‚úÖ Meets requirement (‚â•6 payments)';
                document.getElementById('paymentsStatus').style.color = '#2e7d32';
            } else {
                paymentsCard.classList.remove('pass');
                paymentsCard.classList.add('fail');
                document.getElementById('paymentsStatus').textContent = `‚ùå Need ${6 - paymentsMade} more payment(s)`;
                document.getElementById('paymentsStatus').style.color = '#c62828';
            }
            
            if (daysPass) {
                daysCard.classList.remove('fail');
                daysCard.classList.add('pass');
                document.getElementById('daysStatus').textContent = '‚úÖ Meets requirement (‚â•210 days)';
                document.getElementById('daysStatus').style.color = '#2e7d32';
            } else {
                daysCard.classList.remove('pass');
                daysCard.classList.add('fail');
                document.getElementById('daysStatus').textContent = `‚ùå Need ${210 - daysSinceFirst} more day(s)`;
                document.getElementById('daysStatus').style.color = '#c62828';
            }
            
            // Show/hide alert
            const seasoningAlert = document.getElementById('seasoningAlert');
            if (!paymentsPass || !daysPass) {
                let message = 'This loan does NOT meet FHA streamline seasoning requirements: ';
                const reasons = [];
                if (!paymentsPass) reasons.push(`Only ${paymentsMade} payment(s) made (need 6)`);
                if (!daysPass) reasons.push(`Only ${daysSinceFirst} days elapsed (need 210)`);
                message += reasons.join(' and ');
                
                document.getElementById('seasoningMessage').textContent = message;
                seasoningAlert.style.display = 'block';
            } else {
                seasoningAlert.style.display = 'none';
            }
            
            // Recalculate streamline (UFMIP refund depends on loan age)
            calculateStreamline();
        }
        
        // Calculate UFMIP Refund
        function calculateUFMIPRefund() {
            const endorsementDate = document.getElementById('endorsementDate').value;
            const currentDate = document.getElementById('currentDate').value;
            const originalLoanAmount = parseNum(document.getElementById('sl_originalLoanAmount').value);
            
            if (!endorsementDate || !currentDate || originalLoanAmount === 0) {
                return 0;
            }
            
            // Check if endorsed after Sept 1, 1983
            const endorsement = new Date(endorsementDate);
            const cutoffDate = new Date('1983-09-01');
            
            if (endorsement < cutoffDate) {
                return 0; // No refund for loans endorsed before 9/1/1983
            }
            
            // Calculate original UFMIP (1.75% of original loan amount)
            const originalUFMIP = originalLoanAmount * 0.0175;
            
            // Calculate months since endorsement (closing date)
            const monthsSince = monthsBetween(endorsementDate, currentDate);
            
            // Find refund percentage from table
            let refundPercent = 0;
            
            // Find the exact month or use the last entry for 37+
            const entry = refundTable.find(item => {
                if (item.months >= 37) {
                    return monthsSince >= 37;
                }
                return monthsSince === item.months;
            });
            
            if (entry) {
                refundPercent = entry.refund;
            } else if (monthsSince > 36) {
                // If past 36 months, no refund
                refundPercent = 0;
            }
            
            return originalUFMIP * (refundPercent / 100);
        }
        
        // Calculate Streamline
        function calculateStreamline() {
            const upb = parseNum(document.getElementById('sl_upb').value);
            const accruedInterest = parseNum(document.getElementById('sl_accruedInterest').value);
            
            // Sum all closing costs
            const costOrigination = parseNum(document.getElementById('cost_origination').value);
            const costProcessing = parseNum(document.getElementById('cost_processing').value);
            const costUnderwriting = parseNum(document.getElementById('cost_underwriting').value);
            const costPoints = parseNum(document.getElementById('cost_points').value);
            const costCredit = parseNum(document.getElementById('cost_credit').value);
            const costFlood = parseNum(document.getElementById('cost_flood').value);
            const costInspection = parseNum(document.getElementById('cost_inspection').value);
            const costTitleSearch = parseNum(document.getElementById('cost_title_search').value);
            const costTitleInsurance = parseNum(document.getElementById('cost_title_insurance').value);
            const costRecording = parseNum(document.getElementById('cost_recording').value);
            const costAttorney = parseNum(document.getElementById('cost_attorney').value);
            const costSurvey = parseNum(document.getElementById('cost_survey').value);
            const costPest = parseNum(document.getElementById('cost_pest').value);
            const costOther = parseNum(document.getElementById('cost_other').value);
            
            const totalClosingCosts = costOrigination + costProcessing + costUnderwriting + costPoints +
                                     costCredit + costFlood + costInspection + costTitleSearch +
                                     costTitleInsurance + costRecording + costAttorney + costSurvey +
                                     costPest + costOther;
            
            // Display total closing costs
            document.getElementById('sl_totalClosingCosts').textContent = formatCurrency(totalClosingCosts);
            
            // Calculate UFMIP refund
            const ufmipRefund = calculateUFMIPRefund();
            document.getElementById('sl_ufmipRefund').value = formatCurrency(ufmipRefund);
            
            // Base loan = UPB - UFMIP Refund + Accrued Interest + Closing Costs
            const baseAmount = upb - ufmipRefund + accruedInterest + totalClosingCosts;
            
            // New UFMIP = 1.75% of base amount
            const newUFMIP = baseAmount * 0.0175;
            
            // Final loan amount
            const finalAmount = baseAmount + newUFMIP;
            
            // Update display
            document.getElementById('sl_baseAmount').textContent = formatCurrency(baseAmount);
            document.getElementById('sl_newUFMIP').value = formatCurrency(newUFMIP);
            document.getElementById('sl_finalResult').textContent = formatCurrency(finalAmount);
        }
        
        // Net Tangible Benefit Test
        function checkNTB() {
            const oldRate = parseNum(document.getElementById('ntb_oldRate').value);
            const newRate = parseNum(document.getElementById('ntb_newRate').value);
            const oldPayment = parseNum(document.getElementById('ntb_oldPayment').value);
            const newPayment = parseNum(document.getElementById('ntb_newPayment').value);
            const oldType = document.getElementById('ntb_oldType').value;
            const newType = document.getElementById('ntb_newType').value;
            
            const resultsDiv = document.getElementById('ntbResults');
            
            if (!oldRate || !newRate || !oldPayment || !newPayment) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            resultsDiv.style.display = 'block';
            
            const rateReduction = oldRate - newRate;
            const paymentReduction = oldPayment - newPayment;
            const paymentChange = ((newPayment - oldPayment) / oldPayment) * 100;
            
            let passes = false;
            let reasons = [];
            
            // Determine scenario and apply rules
            if (oldType === 'fixed' && newType === 'fixed') {
                // Fixed to Fixed: Rate must reduce by 0.5% OR payment must reduce
                if (rateReduction >= 0.5) {
                    passes = true;
                    reasons.push(`‚úÖ Rate reduction of ${rateReduction.toFixed(3)}% meets minimum 0.5% requirement`);
                } else if (paymentReduction > 0) {
                    passes = true;
                    reasons.push(`‚úÖ Payment reduced by ${formatCurrency(paymentReduction)} (${Math.abs(paymentChange).toFixed(2)}%)`);
                } else {
                    reasons.push(`‚ùå Rate reduction of ${rateReduction.toFixed(3)}% does not meet 0.5% minimum`);
                    if (paymentChange > 0) {
                        reasons.push(`‚ùå Payment increased by ${formatCurrency(Math.abs(paymentReduction))} (${paymentChange.toFixed(2)}%)`);
                    }
                }
            } else if (oldType === 'arm' && newType === 'fixed') {
                // ARM to Fixed: Payment cannot increase more than 20%
                if (paymentChange <= 20) {
                    passes = true;
                    if (paymentChange < 0) {
                        reasons.push(`‚úÖ Payment reduced by ${formatCurrency(paymentReduction)} (${Math.abs(paymentChange).toFixed(2)}%)`);
                    } else {
                        reasons.push(`‚úÖ Payment increased by ${paymentChange.toFixed(2)}%, within 20% limit`);
                    }
                } else {
                    reasons.push(`‚ùå Payment increased by ${paymentChange.toFixed(2)}%, exceeds 20% limit for ARM to Fixed`);
                }
            } else if (oldType === 'fixed' && newType === 'arm') {
                // Fixed to ARM: Must show payment reduction
                if (paymentReduction > 0) {
                    passes = true;
                    reasons.push(`‚úÖ Payment reduced by ${formatCurrency(paymentReduction)} (${Math.abs(paymentChange).toFixed(2)}%)`);
                } else {
                    reasons.push(`‚ùå Fixed to ARM requires payment reduction. Current change: ${paymentChange >= 0 ? '+' : ''}${paymentChange.toFixed(2)}%`);
                }
            } else if (oldType === 'arm' && newType === 'arm') {
                // ARM to ARM: Rate or payment must reduce
                if (rateReduction > 0 || paymentReduction > 0) {
                    passes = true;
                    if (rateReduction > 0) {
                        reasons.push(`‚úÖ Rate reduced by ${rateReduction.toFixed(3)}%`);
                    }
                    if (paymentReduction > 0) {
                        reasons.push(`‚úÖ Payment reduced by ${formatCurrency(paymentReduction)} (${Math.abs(paymentChange).toFixed(2)}%)`);
                    }
                } else {
                    reasons.push(`‚ùå ARM to ARM requires rate OR payment reduction`);
                    reasons.push(`Current rate change: ${rateReduction >= 0 ? '+' : ''}${rateReduction.toFixed(3)}%`);
                    reasons.push(`Current payment change: ${paymentChange >= 0 ? '+' : ''}${paymentChange.toFixed(2)}%`);
                }
            }
            
            // Display results
            let html = '<div style="padding: 1rem; border-radius: 6px; border: 2px solid; ';
            html += passes ? 'background: #e8f5e9; border-color: #2e7d32;">' : 'background: #ffebee; border-color: #c62828;">';
            html += '<h3 style="margin: 0 0 0.5rem 0; color: ' + (passes ? '#2e7d32' : '#c62828') + ';">';
            html += passes ? '‚úÖ NTB Test: PASS' : '‚ùå NTB Test: FAIL';
            html += '</h3>';
            html += '<div style="margin-bottom: 1rem;"><strong>Scenario:</strong> ' + oldType.toUpperCase() + ' ‚Üí ' + newType.toUpperCase() + '</div>';
            html += '<ul style="margin: 0; padding-left: 1.5rem;">';
            reasons.forEach(reason => {
                html += '<li style="margin-bottom: 0.5rem;">' + reason + '</li>';
            });
            html += '</ul>';
            
            // Add comparison details
            html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">';
            html += '<div><strong>Rate Change:</strong> ' + (rateReduction >= 0 ? '-' : '+') + Math.abs(rateReduction).toFixed(3) + '%</div>';
            html += '<div><strong>Payment Change:</strong> ' + (paymentReduction >= 0 ? '-' : '+') + formatCurrency(Math.abs(paymentReduction)) + ' (' + (paymentChange >= 0 ? '+' : '') + paymentChange.toFixed(2) + '%)</div>';
            html += '</div>';
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
